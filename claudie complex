"""
Basit Kapasite Planlama - Class'sÄ±z Versiyon
Kendi DataFrame'inle Ã§alÄ±ÅŸÄ±r
"""

import pandas as pd
import numpy as np
import math

# =============================================================================
# KONFIGURASYON
# =============================================================================

CONFIG = {
    'aht': 180,          # saniye (Average Handle Time)
    'target_asa': 30,    # 30 saniye iÃ§inde yanÄ±t
    'target_sl': 0.80,   # %80 servis seviyesi
    'shrinkage': 0.10,   # %10 mola/eÄŸitim/izin
    'interval_minutes': 30
}

# Beceri Matrisi: Hangi agent hangi kuyruÄŸu karÅŸÄ±lar?
SKILL_MATRIX = {
    'agent_a': {'queue_a': True, 'queue_b': False},  # A sadece A kuyruÄŸu
    'agent_b': {'queue_a': True, 'queue_b': True}    # B hem A hem B kuyruÄŸu
}

# Kuyruk Ã¶ncelikleri (1 = en yÃ¼ksek)
QUEUE_PRIORITIES = {
    'queue_b': 1,  # B Ã¶ncelikli
    'queue_a': 2
}


# =============================================================================
# ERLANG C HESAPLAMALARI
# =============================================================================

def erlang_c(agents, traffic):
    """Erlang C formÃ¼lÃ¼ - Kuyrukta bekleme olasÄ±lÄ±ÄŸÄ±"""
    if agents <= traffic or agents == 0:
        return 1.0
    
    # Erlang B hesapla
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    
    # Erlang C hesapla
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_asa(agents, traffic, aht):
    """ASA (Average Speed to Answer) hesapla - saniye cinsinden"""
    if agents <= traffic or agents == 0:
        return 999
    
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa


def calculate_service_level(agents, traffic, aht, target_seconds):
    """Servis seviyesi hesapla (X saniye iÃ§inde yanÄ±t oranÄ±)"""
    if agents <= traffic or agents == 0:
        return 0.0
    
    ec = erlang_c(agents, traffic)
    exp_term = math.exp(-(agents - traffic) * (target_seconds / aht))
    sl = 1 - (ec * exp_term)
    return max(0, min(1, sl))


def find_agents_for_target(calls, interval_min, aht, target_asa):
    """Hedef ASA iÃ§in gereken minimum agent sayÄ±sÄ±nÄ± bul"""
    if calls == 0:
        return 0
    
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 3) + 10
    
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    
    return max_agents


# =============================================================================
# BAÄIMSIZ HESAPLAMA (YardÄ±mlaÅŸma Yok)
# =============================================================================

def calculate_independent(df, config):
    """
    Her kuyruk iÃ§in BAÄIMSIZ agent ihtiyacÄ±nÄ± hesapla
    Kuyruklar arasÄ± yardÄ±mlaÅŸma yok
    """
    results = []
    
    for idx, row in df.iterrows():
        calls_a = row.get('queue_a', 0)
        calls_b = row.get('queue_b', 0)
        
        # A kuyruÄŸu iÃ§in agent
        agents_a = find_agents_for_target(
            calls_a,
            config['interval_minutes'],
            config['aht'],
            config['target_asa']
        )
        
        # B kuyruÄŸu iÃ§in agent
        agents_b = find_agents_for_target(
            calls_b,
            config['interval_minutes'],
            config['aht'],
            config['target_asa']
        )
        
        # Shrinkage ekle
        final_a = math.ceil(agents_a / (1 - config['shrinkage']))
        final_b = math.ceil(agents_b / (1 - config['shrinkage']))
        
        results.append({
            'time': row['time'],
            'calls_a': calls_a,
            'calls_b': calls_b,
            'agents_a': final_a,
            'agents_b': final_b,
            'total_agents': final_a + final_b
        })
    
    return pd.DataFrame(results)


# =============================================================================
# HAFTA Ä°Ã‡Ä° HESAPLAMA (B AgentlarÄ± A'ya YardÄ±m Eder)
# =============================================================================

def calculate_weekday_with_support(df, config):
    """
    Hafta iÃ§i hesaplama - B agentlarÄ± boÅŸ kalÄ±rsa A kuyruÄŸuna yardÄ±m eder
    
    MantÄ±k:
    1. Ã–nce B kuyruÄŸu iÃ§in gereken B agentlarÄ±nÄ± hesapla
    2. Sonra A kuyruÄŸu iÃ§in agent hesapla ama B agentlarÄ± da A'ya yardÄ±m edebilir
    """
    results = []
    
    for idx, row in df.iterrows():
        calls_a = row.get('queue_a', 0)
        calls_b = row.get('queue_b', 0)
        
        # AdÄ±m 1: B kuyruÄŸu iÃ§in gereken B agentlarÄ±
        agents_b_needed = find_agents_for_target(
            calls_b,
            config['interval_minutes'],
            config['aht'],
            config['target_asa']
        )
        
        # AdÄ±m 2: A kuyruÄŸu iÃ§in ek agent gerekir mi?
        # B agentlarÄ± hem A hem B'ye bakabilir, bu yÃ¼zden:
        # - EÄŸer B agentlarÄ± yeterliyse, A iÃ§in ekstra agent gerekmez
        # - DeÄŸilse, sadece A'ya bakmak iÃ§in A agentlarÄ± ekle
        
        # Toplam Ã§aÄŸrÄ± yÃ¼kÃ¼nÃ¼ kontrol et
        total_calls = calls_a + calls_b
        
        # B agentlarÄ±nÄ±n toplam kapasitesi yeterli mi?
        agents_b_for_all = find_agents_for_target(
            total_calls,
            config['interval_minutes'],
            config['aht'],
            config['target_asa']
        )
        
        if agents_b_for_all <= agents_b_needed:
            # B agentlarÄ± hem A hem B'yi karÅŸÄ±lar
            agents_a_needed = 0
            agents_b_final = agents_b_for_all
        else:
            # B agentlarÄ± B'yi karÅŸÄ±lar, A iÃ§in ekstra A agentÄ± gerek
            agents_b_final = agents_b_needed
            
            # Kalan A Ã§aÄŸrÄ±larÄ± iÃ§in A agentÄ±
            remaining_a_calls = calls_a
            agents_a_needed = find_agents_for_target(
                remaining_a_calls,
                config['interval_minutes'],
                config['aht'],
                config['target_asa']
            )
        
        # Shrinkage ekle
        final_a = math.ceil(agents_a_needed / (1 - config['shrinkage']))
        final_b = math.ceil(agents_b_final / (1 - config['shrinkage']))
        
        results.append({
            'time': row['time'],
            'calls_a': calls_a,
            'calls_b': calls_b,
            'agents_a': final_a,
            'agents_b': final_b,
            'total_agents': final_a + final_b
        })
    
    return pd.DataFrame(results)


# =============================================================================
# Ã–NCELÄ°KLÄ° KUYRUK SÄ°MÃœLASYONU (Daha GerÃ§ekÃ§i)
# =============================================================================

def simulate_with_priority(agents_a, agents_b, calls_a, calls_b, config):
    """
    Ã–ncelikli kuyruk mantÄ±ÄŸÄ±yla simÃ¼lasyon
    
    B agentlarÄ± Ã¶nce B Ã§aÄŸrÄ±larÄ±nÄ± alÄ±r, boÅŸ kalÄ±rsa A'ya bakar
    A agentlarÄ± sadece A Ã§aÄŸrÄ±larÄ±na bakar
    """
    interval_sec = config['interval_minutes'] * 60
    aht = config['aht']
    
    # Agent kapasiteleri (saniye cinsinden)
    capacity_a = agents_a * interval_sec
    capacity_b = agents_b * interval_sec
    
    # Ã–nce B Ã§aÄŸrÄ±larÄ± (B agentlarÄ± tarafÄ±ndan karÅŸÄ±lanÄ±r)
    required_for_b = calls_b * aht
    
    if capacity_b >= required_for_b:
        # B agentlarÄ± B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar, kalan kapasite A'ya yardÄ±m eder
        handled_b = calls_b
        remaining_b_capacity = capacity_b - required_for_b
        
        # A Ã§aÄŸrÄ±larÄ± iÃ§in toplam kapasite
        total_capacity_for_a = capacity_a + remaining_b_capacity
        required_for_a = calls_a * aht
        
        if total_capacity_for_a >= required_for_a:
            handled_a = calls_a
        else:
            handled_a = int(total_capacity_for_a / aht)
    else:
        # B agentlarÄ± sadece B Ã§aÄŸrÄ±larÄ±nÄ±n bir kÄ±smÄ±nÄ± karÅŸÄ±lar
        handled_b = int(capacity_b / aht)
        
        # A Ã§aÄŸrÄ±larÄ± sadece A agentlarÄ± tarafÄ±ndan karÅŸÄ±lanÄ±r
        if capacity_a >= calls_a * aht:
            handled_a = calls_a
        else:
            handled_a = int(capacity_a / aht)
    
    # Performans metrikleri
    coverage_a = (handled_a / calls_a * 100) if calls_a > 0 else 100
    coverage_b = (handled_b / calls_b * 100) if calls_b > 0 else 100
    
    return {
        'handled_a': handled_a,
        'handled_b': handled_b,
        'coverage_a': coverage_a,
        'coverage_b': coverage_b
    }


def calculate_with_priority_simulation(df, config):
    """
    SimÃ¼lasyon ile agent sayÄ±sÄ±nÄ± optimize et
    B agentlarÄ± B'ye Ã¶ncelik verir, boÅŸ kalÄ±rsa A'ya yardÄ±m eder
    """
    results = []
    
    for idx, row in df.iterrows():
        calls_a = row.get('queue_a', 0)
        calls_b = row.get('queue_b', 0)
        
        # BaÅŸlangÄ±Ã§ tahmini - baÄŸÄ±msÄ±z hesaplama
        initial_a = find_agents_for_target(calls_a, config['interval_minutes'], 
                                          config['aht'], config['target_asa'])
        initial_b = find_agents_for_target(calls_b, config['interval_minutes'],
                                          config['aht'], config['target_asa'])
        
        # En iyi kombinasyonu bul
        best_agents_a = initial_a
        best_agents_b = initial_b
        best_total = initial_a + initial_b
        
        # Grid search - farklÄ± kombinasyonlarÄ± dene
        for agents_b in range(0, initial_b + 5):
            for agents_a in range(0, initial_a + 5):
                perf = simulate_with_priority(
                    agents_a, agents_b, calls_a, calls_b, config
                )
                
                # Hedefleri karÅŸÄ±lÄ±yor mu?
                if perf['coverage_a'] >= 95 and perf['coverage_b'] >= 95:
                    total = agents_a + agents_b
                    if total < best_total:
                        best_total = total
                        best_agents_a = agents_a
                        best_agents_b = agents_b
        
        # Shrinkage ekle
        final_a = math.ceil(best_agents_a / (1 - config['shrinkage']))
        final_b = math.ceil(best_agents_b / (1 - config['shrinkage']))
        
        # Final simÃ¼lasyon
        final_perf = simulate_with_priority(
            best_agents_a, best_agents_b, calls_a, calls_b, config
        )
        
        results.append({
            'time': row['time'],
            'calls_a': calls_a,
            'calls_b': calls_b,
            'agents_a': final_a,
            'agents_b': final_b,
            'total_agents': final_a + final_b,
            'coverage_a': round(final_perf['coverage_a'], 1),
            'coverage_b': round(final_perf['coverage_b'], 1)
        })
    
    return pd.DataFrame(results)


# =============================================================================
# KARÅILAÅTIRMA ve RAPORLAMA
# =============================================================================

def compare_methods(df, config):
    """
    FarklÄ± hesaplama yÃ¶ntemlerini karÅŸÄ±laÅŸtÄ±r
    """
    print("=" * 80)
    print("KAPASÄ°TE PLANLAMA KARÅILAÅTIRMASI")
    print("=" * 80)
    
    # YÃ¶ntem 1: BaÄŸÄ±msÄ±z (yardÄ±mlaÅŸma yok)
    print("\n[1/3] BaÄŸÄ±msÄ±z hesaplama yapÄ±lÄ±yor...")
    independent = calculate_independent(df, config)
    
    # YÃ¶ntem 2: Hafta iÃ§i (basit yardÄ±mlaÅŸma)
    print("[2/3] Hafta iÃ§i (yardÄ±mlaÅŸmalÄ±) hesaplama yapÄ±lÄ±yor...")
    weekday = calculate_weekday_with_support(df, config)
    
    # YÃ¶ntem 3: Ã–ncelikli simÃ¼lasyon
    print("[3/3] Ã–ncelikli simÃ¼lasyon yapÄ±lÄ±yor...")
    priority = calculate_with_priority_simulation(df, config)
    
    # Ã–zet istatistikler
    print("\n" + "=" * 80)
    print("ğŸ“Š Ã–ZET Ä°STATÄ°STÄ°KLER")
    print("=" * 80)
    
    methods = {
        'BaÄŸÄ±msÄ±z (YardÄ±mlaÅŸma Yok)': independent,
        'Hafta Ä°Ã§i (Basit YardÄ±mlaÅŸma)': weekday,
        'Ã–ncelikli SimÃ¼lasyon': priority
    }
    
    for method_name, result_df in methods.items():
        print(f"\nğŸ“ˆ {method_name}")
        print(f"  Peak Agent: {result_df['total_agents'].max()}")
        print(f"  Ortalama Agent: {result_df['total_agents'].mean():.1f}")
        print(f"  GÃ¼nlÃ¼k Toplam: {result_df['total_agents'].sum()}")
        print(f"  - A AgentlarÄ±: Peak={result_df['agents_a'].max()}, Ort={result_df['agents_a'].mean():.1f}")
        print(f"  - B AgentlarÄ±: Peak={result_df['agents_b'].max()}, Ort={result_df['agents_b'].mean():.1f}")
    
    # Tasarruf analizi
    print("\n" + "=" * 80)
    print("ğŸ’° TASARRUF ANALÄ°ZÄ°")
    print("=" * 80)
    
    baseline = independent['total_agents'].sum()
    
    for method_name, result_df in methods.items():
        if method_name == 'BaÄŸÄ±msÄ±z (YardÄ±mlaÅŸma Yok)':
            continue
        
        total = result_df['total_agents'].sum()
        saving = baseline - total
        saving_pct = (saving / baseline * 100) if baseline > 0 else 0
        
        print(f"\n{method_name}:")
        print(f"  Tasarruf: {saving:.0f} agent-saat ({saving_pct:.1f}%)")
    
    return {
        'independent': independent,
        'weekday': weekday,
        'priority': priority
    }


# =============================================================================
# ANA FONKSÄ°YON - KENDI DATANÄ± KULLAN
# =============================================================================

def calculate_capacity_planning(df, weekday=True, method='priority'):
    """
    Ana fonksiyon - kendi DataFrame'inle Ã§alÄ±ÅŸ
    
    Parameters:
    -----------
    df : pandas.DataFrame
        'time', 'queue_a', 'queue_b' kolonlarÄ± olmalÄ±
    weekday : bool
        True = Hafta iÃ§i (yardÄ±mlaÅŸma var)
        False = Hafta sonu (yardÄ±mlaÅŸma yok)
    method : str
        'independent' = YardÄ±mlaÅŸma yok
        'simple' = Basit yardÄ±mlaÅŸma
        'priority' = Ã–ncelikli simÃ¼lasyon (en gerÃ§ekÃ§i)
    
    Returns:
    --------
    pandas.DataFrame
        Agent ihtiyaÃ§larÄ±
    """
    
    # Gerekli kolonlarÄ± kontrol et
    required_cols = ['time', 'queue_a', 'queue_b']
    missing_cols = [col for col in required_cols if col not in df.columns]
    
    if missing_cols:
        raise ValueError(f"Eksik kolonlar: {missing_cols}")
    
    print(f"\nğŸš€ Kapasite PlanlamasÄ± BaÅŸlatÄ±lÄ±yor...")
    print(f"  - DÃ¶nem: {'Hafta Ä°Ã§i' if weekday else 'Hafta Sonu'}")
    print(f"  - YÃ¶ntem: {method}")
    print(f"  - Ä°nterval SayÄ±sÄ±: {len(df)}")
    print(f"  - Toplam A Ã‡aÄŸrÄ±larÄ±: {df['queue_a'].sum()}")
    print(f"  - Toplam B Ã‡aÄŸrÄ±larÄ±: {df['queue_b'].sum()}")
    
    # YÃ¶nteme gÃ¶re hesapla
    if not weekday or method == 'independent':
        result = calculate_independent(df, CONFIG)
    elif method == 'simple':
        result = calculate_weekday_with_support(df, CONFIG)
    elif method == 'priority':
        result = calculate_with_priority_simulation(df, CONFIG)
    else:
        raise ValueError(f"GeÃ§ersiz method: {method}")
    
    print("\nâœ… Hesaplama tamamlandÄ±!\n")
    
    return result


# =============================================================================
# Ã–RNEK KULLANIM
# =============================================================================

if __name__ == '__main__':
    # Ã–rnek veri oluÅŸtur
    times = pd.date_range('00:00', '23:30', freq='30min').strftime('%H:%M')
    
    # GerÃ§ekÃ§i Ã§aÄŸrÄ± paterni
    np.random.seed(42)
    
    sample_data = pd.DataFrame({
        'time': times,
        'queue_a': [10, 12, 15, 18, 25, 30, 35, 40, 45, 50, 48, 47,  # 00:00 - 05:30
                    42, 38, 35, 32, 30, 35, 45, 55, 60, 58, 56, 54,  # 06:00 - 11:30
                    52, 50, 48, 46, 44, 40, 38, 36, 34, 32, 30, 28,  # 12:00 - 17:30
                    25, 22, 20, 18, 16, 14, 12, 10, 8, 6, 5, 4],     # 18:00 - 23:30
        'queue_b': [5, 6, 8, 10, 12, 15, 18, 20, 22, 25, 24, 23,     # 00:00 - 05:30
                    22, 20, 18, 16, 15, 18, 22, 28, 30, 29, 28, 27,  # 06:00 - 11:30
                    26, 25, 24, 23, 22, 20, 19, 18, 17, 16, 15, 14,  # 12:00 - 17:30
                    13, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 2]          # 18:00 - 23:30
    })
    
    print("\n" + "=" * 80)
    print("Ã–RNEK KULLANIM - KENDÄ° VERÄ°NLE")
    print("=" * 80)
    print(f"\nVeri boyutu: {len(sample_data)} satÄ±r")
    print(f"Zaman aralÄ±ÄŸÄ±: {sample_data['time'].iloc[0]} - {sample_data['time'].iloc[-1]}")
    
    # TEK BÄ°R YÃ–NTEMLE HESAPLAMA
    print("\n" + "=" * 80)
    print("YÃ–NTEM: Ã–NCELÄ°KLÄ° SÄ°MÃœLASYON")
    print("=" * 80)
    result = calculate_capacity_planning(sample_data, weekday=True, method='priority')
    
    print("\nğŸ“Š Ä°lk 10 satÄ±r:")
    print(result[['time', 'calls_a', 'calls_b', 'agents_a', 'agents_b', 
                  'total_agents', 'coverage_a', 'coverage_b']].head(10))
    
    print("\nğŸ“ˆ Ã–zet:")
    print(f"  Peak Saat: {result.loc[result['total_agents'].idxmax(), 'time']}")
    print(f"  Peak Agent: {result['total_agents'].max()}")
    print(f"  Ortalama Agent: {result['total_agents'].mean():.1f}")
    
    # TÃœM YÃ–NTEMLERÄ° KARÅILAÅTIR
    print("\n\n" + "=" * 80)
    print("TÃœM YÃ–NTEMLERÄ° KARÅILAÅTIR")
    print("=" * 80)
    all_results = compare_methods(sample_data, CONFIG)
    
    # Peak saati detaylÄ± gÃ¶ster
    peak_time = result.loc[result['total_agents'].idxmax(), 'time']
    print(f"\nğŸ” PEAK SAAT DETAYI ({peak_time}):")
    print("=" * 80)
    
    for method_name, result_df in all_results.items():
        peak_row = result_df[result_df['time'] == peak_time].iloc[0]
        print(f"\n{method_name}:")
        print(f"  A AgentlarÄ±: {peak_row['agents_a']}")
        print(f"  B AgentlarÄ±: {peak_row['agents_b']}")
        print(f"  Toplam: {peak_row['total_agents']}")




import pandas as pd

# Kendi verini oku
df = pd.read_excel('cagri_tahminleri.xlsx')  # veya csv
# Kolonlar: time, queue_a, queue_b

# Hesapla
result = calculate_capacity_planning(
    df, 
    weekday=True,      # True = Hafta iÃ§i, False = Hafta sonu
    method='priority'   # 'independent', 'simple', veya 'priority'
)

# Sonucu gÃ¶ster
print(result)

# Excel'e kaydet
result.to_excel('agent_ihtiyaci.xlsx', index=False)
