import pandas as pd
import numpy as np
import math

# KonfigÃ¼rasyon
CONFIG = {
    'aht': 188,          # saniye
    'target_sl': 0.80,   # %80 servis seviyesi
    'target_asa': 30,    # 30 saniye iÃ§inde yanÄ±t
    'shrinkage': 0.10,   # %10 mola/eÄŸitim/izin
    'interval_minutes': 30
}

# Vardiya tanÄ±mlarÄ±
SHIFTS = [
    {'name': 'V1', 'start': '07:00', 'end': '16:00', 'duration': 9},
    {'name': 'V2', 'start': '08:00', 'end': '17:00', 'duration': 9},
    {'name': 'V3', 'start': '09:00', 'end': '18:00', 'duration': 9},
    {'name': 'V4', 'start': '10:00', 'end': '19:00', 'duration': 9},
    {'name': 'V5', 'start': '15:00', 'end': '24:00', 'duration': 9},
    {'name': 'V6', 'start': '17:00', 'end': '01:00', 'duration': 8, 'overnight': True},
    {'name': 'V7', 'start': '18:00', 'end': '02:00', 'duration': 8, 'overnight': True},
    {'name': 'V8', 'start': '19:00', 'end': '03:00', 'duration': 8, 'overnight': True},
    {'name': 'V9', 'start': '00:00', 'end': '08:00', 'duration': 8},
    {'name': 'V10', 'start': '08:00', 'end': '17:30', 'duration': 9.5},
    {'name': 'V11', 'start': '09:00', 'end': '18:30', 'duration': 9.5},
    {'name': 'V12', 'start': '10:00', 'end': '19:30', 'duration': 9.5},
    {'name': 'V13', 'start': '11:00', 'end': '20:30', 'duration': 9.5},
    {'name': 'V14', 'start': '12:00', 'end': '21:30', 'duration': 9.5},
    {'name': 'V15', 'start': '13:00', 'end': '22:30', 'duration': 9.5},
    {'name': 'V16', 'start': '14:00', 'end': '23:30', 'duration': 9.5},
    {'name': 'V17', 'start': '15:00', 'end': '00:30', 'duration': 9.5, 'overnight': True},
    {'name': 'V18', 'start': '17:00', 'end': '01:30', 'duration': 8.5, 'overnight': True},
    {'name': 'V19', 'start': '18:00', 'end': '02:30', 'duration': 8.5, 'overnight': True}
]


def erlang_c(agents, traffic):
    """Erlang C formÃ¼lÃ¼ ile kuyruk olasÄ±lÄ±ÄŸÄ± (bekleme olasÄ±lÄ±ÄŸÄ±) hesapla."""
    if agents <= traffic or agents == 0:
        return 1.0

    # Erlang B hesapla
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)

    # Erlang C hesapla
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_agents(calls, interval_min, aht, target_asa):
    """Belirli bir Ã§aÄŸrÄ± hacmi iÃ§in, hedef ASA'yÄ± saÄŸlayacak minimum agent sayÄ±sÄ±nÄ± bul."""
    if calls == 0:
        return 0

    # Traffic hesapla (Erlang birimiyle)
    traffic = (calls * (aht / 60)) / interval_min  # AHT'yi dakikaya Ã§evirip kullanÄ±yor

    if traffic == 0:
        return 0

    # Agent sayÄ±sÄ±nÄ± aradÄ±ÄŸÄ±mÄ±z aralÄ±k
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 3) + 5

    # Basit bir lineer arama (binary search yerine), min'den max'e doÄŸru
    for agents in range(min_agents, max_agents + 1):
        ec = erlang_c(agents, traffic)

        # ASA hesapla (saniye)
        if agents > traffic:
            asa = (ec * (aht / 60)) / (agents - traffic) * 60
        else:
            asa = 999  # yetersiz agent => Ã§ok yÃ¼ksek ASA

        if asa <= target_asa:
            return agents

    return max_agents


def calculate_weekday_staffing(df):
    """
    Hafta iÃ§i agent ihtiyacÄ±nÄ± hesaplar.

    MantÄ±k:
    - B kuyruÄŸuna gelen Ã§aÄŸrÄ±larÄ± SADECE B agentlarÄ± karÅŸÄ±lar.
    - A kuyruÄŸuna gelen Ã§aÄŸrÄ±larÄ± hem A hem B agentlarÄ± karÅŸÄ±layabilir.
    - Biz basitleÅŸtirilmiÅŸ olarak:
      * B iÃ§in gereken agent sayÄ±sÄ±nÄ± ayrÄ±
      * A iÃ§in gereken agent sayÄ±sÄ±nÄ± ayrÄ± hesaplÄ±yoruz.
    """
    results = []

    for idx, row in df.iterrows():
        agents_for_b = calculate_agents(
            row['queue_b'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )

        agents_for_a = calculate_agents(
            row['queue_a'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )

        agents_b = agents_for_b
        agents_a = agents_for_a

        # Shrinkage ekle
        final_agents_a = math.ceil(agents_a / (1 - CONFIG['shrinkage']))
        final_agents_b = math.ceil(agents_b / (1 - CONFIG['shrinkage']))

        results.append({
            'time': row['time'],
            'queue_a_calls': row['queue_a'],
            'queue_b_calls': row['queue_b'],
            'agents_a': final_agents_a,
            'agents_b': final_agents_b,
            'total_agents': final_agents_a + final_agents_b
        })

    return pd.DataFrame(results)


def calculate_weekend_staffing(df):
    """
    Hafta sonu agent ihtiyacÄ±nÄ± hesaplar.

    MantÄ±k:
    - Kuyruklar arasÄ± yardÄ±m yok.
    - A kuyruÄŸu sadece A agentlarÄ±,
    - B kuyruÄŸu sadece B agentlarÄ±.
    """
    results = []

    for idx, row in df.iterrows():
        agents_a = calculate_agents(
            row['queue_a'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )

        agents_b = calculate_agents(
            row['queue_b'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )

        final_agents_a = math.ceil(agents_a / (1 - CONFIG['shrinkage']))
        final_agents_b = math.ceil(agents_b / (1 - CONFIG['shrinkage']))

        results.append({
            'time': row['time'],
            'queue_a_calls': row['queue_a'],
            'queue_b_calls': row['queue_b'],
            'agents_a': final_agents_a,
            'agents_b': final_agents_b,
            'total_agents': final_agents_a + final_agents_b
        })

    return pd.DataFrame(results)


def is_time_in_shift(time_str, shift):
    """Verilen 'HH:MM' zamanÄ±nÄ±n, ilgili vardiyanÄ±n iÃ§inde olup olmadÄ±ÄŸÄ±nÄ± kontrol eder."""
    h, m = map(int, time_str.split(':'))
    time_minutes = h * 60 + m

    start_h, start_m = map(int, shift['start'].split(':'))
    start_minutes = start_h * 60 + start_m

    end_h, end_m = map(int, shift['end'].split(':'))
    end_minutes = end_h * 60 + end_m

    # Gece vardiyalarÄ± iÃ§in
    if shift.get('overnight', False) and end_minutes <= start_minutes:
        end_minutes += 24 * 60
        if time_minutes < start_minutes:
            time_minutes += 24 * 60

    return start_minutes <= time_minutes < end_minutes


def calculate_shift_requirements(weekday_df, weekend_df):
    """
    Vardiya bazlÄ± agent ihtiyacÄ±nÄ± hesaplar.
    Her vardiya iÃ§in, o vardiyanÄ±n kapsadÄ±ÄŸÄ± zaman dilimlerindeki maksimum
    toplam agent ihtiyacÄ±nÄ± alÄ±r.
    """
    shift_results = []

    for shift in SHIFTS:
        weekday_intervals = weekday_df[
            weekday_df['time'].apply(lambda x: is_time_in_shift(x, shift))
        ]
        weekday_max = weekday_intervals['total_agents'].max() if len(weekday_intervals) > 0 else 0

        weekend_intervals = weekend_df[
            weekend_df['time'].apply(lambda x: is_time_in_shift(x, shift))
        ]
        weekend_max = weekend_intervals['total_agents'].max() if len(weekend_intervals) > 0 else 0

        shift_results.append({
            'shift_name': shift['name'],
            'start_time': shift['start'],
            'end_time': shift['end'],
            'duration_hours': shift['duration'],
            'weekday_agents_needed': int(weekday_max),
            'weekend_agents_needed': int(weekend_max)
        })

    return pd.DataFrame(shift_results)


def calculate_with_custom_data(df_weekday, df_weekend=None):
    """
    Kendi Ã§aÄŸrÄ± verinle hesaplama yap.

    df_weekday: time, queue_a, queue_b
    df_weekend: time, queue_a, queue_b (opsiyonel)
    """
    print("\nğŸ“Š Kendi verinle hesaplama yapÄ±lÄ±yor...")
    print(f"Hafta iÃ§i veri: {len(df_weekday)} satÄ±r")

    weekday_staffing = calculate_weekday_staffing(df_weekday)

    if df_weekend is not None:
        print(f"Hafta sonu veri: {len(df_weekend)} satÄ±r")
        weekend_staffing = calculate_weekend_staffing(df_weekend)
    else:
        print("Hafta sonu veri yok, hafta iÃ§i verinin %60'Ä± kullanÄ±lÄ±yor")
        df_weekend_generated = df_weekday.copy()
        df_weekend_generated['queue_a'] = (df_weekend_generated['queue_a'] * 0.6).round()
        df_weekend_generated['queue_b'] = (df_weekend_generated['queue_b'] * 0.6).round()
        weekend_staffing = calculate_weekend_staffing(df_weekend_generated)

    shift_analysis = calculate_shift_requirements(weekday_staffing, weekend_staffing)

    return weekday_staffing, weekend_staffing, shift_analysis


def main(df_weekday, df_weekend=None):
    """Ana fonksiyon - dÄ±ÅŸarÄ±dan verilen df'lerle tÃ¼m hesaplamayÄ± yapar."""
    print("=" * 80)
    print("Ã‡AÄRI MERKEZÄ° KAPASÄ°TE PLANLAMA ANALÄ°ZÄ°")
    print("=" * 80)
    print(f"\nKonfigÃ¼rasyon:")
    print(f"  - AHT: {CONFIG['aht']} saniye")
    print(f"  - Hedef Servis Seviyesi: {CONFIG['target_sl']*100}%")
    print(f"  - Hedef YanÄ±t SÃ¼resi: {CONFIG['target_asa']} saniye")
    print(f"  - Shrinkage: {CONFIG['shrinkage']*100}%")
    print(f"\nKuyruk MantÄ±ÄŸÄ±:")
    print(f"  - Hafta Ä°Ã§i: B agentlarÄ± B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar + A'ya yardÄ±m eder")
    print(f"  - Hafta Sonu: Kuyruklar baÄŸÄ±msÄ±z, yardÄ±m yok")
    print("\n" + "=" * 80)

    print("[1/3] Hafta iÃ§i / hafta sonu agent ihtiyacÄ± hesaplanÄ±yor...")
    weekday_staffing, weekend_staffing, shift_analysis = calculate_with_custom_data(
        df_weekday, df_weekend
    )

    # Ã–zet istatistikler
    print("\n" + "=" * 80)
    print("ğŸ“Š HAFTA Ä°Ã‡Ä° Ã–ZET")
    print("-" * 80)
    print(f"Toplam GÃ¼nlÃ¼k Ã‡aÄŸrÄ±: {weekday_staffing['queue_a_calls'].sum() + weekday_staffing['queue_b_calls'].sum()}")
    print(f"  - A KuyruÄŸu: {weekday_staffing['queue_a_calls'].sum()}")
    print(f"  - B KuyruÄŸu: {weekday_staffing['queue_b_calls'].sum()}")
    print(f"Peak Agent Ä°htiyacÄ±: {weekday_staffing['total_agents'].max()}")
    print(f"  - A AgentlarÄ±: {weekday_staffing['agents_a'].max()}")
    print(f"  - B AgentlarÄ±: {weekday_staffing['agents_b'].max()}")
    print(f"Ortalama Agent Ä°htiyacÄ±: {weekday_staffing['total_agents'].mean():.1f}")
    print(f"Peak Saati: {weekday_staffing.loc[weekday_staffing['total_agents'].idxmax(), 'time']}")

    print("\nğŸ“Š HAFTA SONU Ã–ZET")
    print("-" * 80)
    print(f"Toplam GÃ¼nlÃ¼k Ã‡aÄŸrÄ±: {weekend_staffing['queue_a_calls'].sum() + weekend_staffing['queue_b_calls'].sum()}")
    print(f"  - A KuyruÄŸu: {weekend_staffing['queue_a_calls'].sum()}")
    print(f"  - B KuyruÄŸu: {weekend_staffing['queue_b_calls'].sum()}")
    print(f"Peak Agent Ä°htiyacÄ±: {weekend_staffing['total_agents'].max()}")
    print(f"  - A AgentlarÄ±: {weekend_staffing['agents_a'].max()}")
    print(f"  - B AgentlarÄ±: {weekend_staffing['agents_b'].max()}")
    print(f"Ortalama Agent Ä°htiyacÄ±: {weekend_staffing['total_agents'].mean():.1f}")
    print(f"Peak Saati: {weekend_staffing.loc[weekend_staffing['total_agents'].idxmax(), 'time']}")

    print("\n" + "=" * 80)
    print("\nğŸ“‹ HAFTA Ä°Ã‡Ä° DETAYLI AGENT Ä°HTÄ°YACI (Ä°lk 20 satÄ±r)")
    print("-" * 80)
    print(weekday_staffing.head(20).to_string(index=False))

    print("\n\nğŸ“‹ HAFTA SONU DETAYLI AGENT Ä°HTÄ°YACI (Ä°lk 20 satÄ±r)")
    print("-" * 80)
    print(weekend_staffing.head(20).to_string(index=False))

    print("\n\nğŸ“… VARDÄ°YA BAZLI AGENT Ä°HTÄ°YACI")
    print("-" * 80)
    print(shift_analysis.to_string(index=False))

    print("\n" + "=" * 80)

    # Excel'e kaydet
    try:
        with pd.ExcelWriter('call_center_staffing_plan.xlsx', engine='openpyxl') as writer:
            weekday_staffing.to_excel(writer, sheet_name='Hafta_Ici', index=False)
            weekend_staffing.to_excel(writer, sheet_name='Hafta_Sonu', index=False)
            shift_analysis.to_excel(writer, sheet_name='Vardiya_Plani', index=False)
        print("\nâœ… SonuÃ§lar 'call_center_staffing_plan.xlsx' dosyasÄ±na kaydedildi!")
    except Exception as e:
        print(f"\nâš ï¸  Excel kaydetme hatasÄ±: {e}")
        print("Not: openpyxl kurulu deÄŸilse: pip install openpyxl")

    return weekday_staffing, weekend_staffing, shift_analysis


# Ã‡ALIÅTIRMA Ã–RNEÄÄ°
if __name__ == "__main__":
    # Ã–rnek: kendi haftaiÃ§i df'in
    # df_weekday = dfim_haftaici  # time, queue_a, queue_b
    # df_weekend = dfim_haftasonu  # varsa; yoksa None bÄ±rak

    # Buraya kendi deÄŸiÅŸkenini koyacaksÄ±n:
    # Ã–rneÄŸin sadece haftaiÃ§i verin varsa:
    # df_weekend = None
    # weekday_df, weekend_df, shifts_df = main(df_weekday, df_weekend)

    print("Bu script'i doÄŸrudan Ã§alÄ±ÅŸtÄ±rmak iÃ§in df_weekday ve df_weekend deÄŸiÅŸkenlerini tanÄ±mla.")
