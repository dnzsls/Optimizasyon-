"""
FONKSÄ°YON 6: Tek Interval iÃ§in Tam Hesaplama
A ve B kuyruÄŸu iÃ§in agent hesapla - BAÄIMSIZ (yardÄ±mlaÅŸma yok)
"""
import math

def erlang_c(agents, traffic):
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)

def calculate_asa(agents, traffic, aht):
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa

def find_agents_for_target(calls, interval_min, aht, target_asa):
    if calls == 0:
        return 0
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    return max_agents


def calculate_single_interval(calls_a, calls_b, interval_min=30, aht=180, 
                              target_asa=30, shrinkage=0.10):
    """
    Tek bir zaman dilimi iÃ§in agent hesapla
    
    BAÄIMSIZ YAKLAÅIM:
    - A kuyruÄŸu â†’ A agentlarÄ± karÅŸÄ±lar
    - B kuyruÄŸu â†’ B agentlarÄ± karÅŸÄ±lar
    - YardÄ±mlaÅŸma YOK
    
    Parametreler:
    - calls_a: A kuyruÄŸuna gelen Ã§aÄŸrÄ±
    - calls_b: B kuyruÄŸuna gelen Ã§aÄŸrÄ±
    - interval_min: Ä°nterval (dakika)
    - aht: Average Handle Time (saniye)
    - target_asa: Hedef ASA (saniye)
    - shrinkage: Shrinkage oranÄ± (0.10 = %10)
    
    DÃ¶nÃ¼ÅŸ:
    - SÃ¶zlÃ¼k (agents_a, agents_b, total, detaylar)
    """
    
    # A kuyruÄŸu iÃ§in
    agents_a_raw = find_agents_for_target(calls_a, interval_min, aht, target_asa)
    agents_a_final = math.ceil(agents_a_raw / (1 - shrinkage))
    
    # B kuyruÄŸu iÃ§in
    agents_b_raw = find_agents_for_target(calls_b, interval_min, aht, target_asa)
    agents_b_final = math.ceil(agents_b_raw / (1 - shrinkage))
    
    # Traffic hesapla (doÄŸrulama iÃ§in)
    traffic_a = (calls_a * (aht/60)) / interval_min if calls_a > 0 else 0
    traffic_b = (calls_b * (aht/60)) / interval_min if calls_b > 0 else 0
    
    return {
        'calls_a': calls_a,
        'calls_b': calls_b,
        'traffic_a': round(traffic_a, 2),
        'traffic_b': round(traffic_b, 2),
        'agents_a_raw': agents_a_raw,
        'agents_b_raw': agents_b_raw,
        'agents_a_final': agents_a_final,
        'agents_b_final': agents_b_final,
        'total_agents': agents_a_final + agents_b_final
    }


# TEST EDELÄ°M
if __name__ == '__main__':
    print("=" * 60)
    print("FONKSÄ°YON 6: TEK INTERVAL TAM HESAPLAMA")
    print("=" * 60)
    
    print("\nğŸ“‹ Senaryo:")
    print("  - 09:00-09:30 zaman dilimi")
    print("  - A kuyruÄŸu: 50 Ã§aÄŸrÄ±")
    print("  - B kuyruÄŸu: 30 Ã§aÄŸrÄ±")
    print("  - BAÄIMSIZ hesaplama (yardÄ±mlaÅŸma yok)\n")
    
    # Test 1: Orta yoÄŸun
    result = calculate_single_interval(calls_a=50, calls_b=30)
    
    print("=" * 60)
    print("ğŸ“Š SONUÃ‡LAR")
    print("=" * 60)
    
    print(f"\nğŸ”¹ A KuyruÄŸu:")
    print(f"   Ã‡aÄŸrÄ±: {result['calls_a']}")
    print(f"   Traffic: {result['traffic_a']} Erlang")
    print(f"   Ham Agent: {result['agents_a_raw']}")
    print(f"   +Shrinkage: {result['agents_a_final']} agent")
    
    print(f"\nğŸ”¹ B KuyruÄŸu:")
    print(f"   Ã‡aÄŸrÄ±: {result['calls_b']}")
    print(f"   Traffic: {result['traffic_b']} Erlang")
    print(f"   Ham Agent: {result['agents_b_raw']}")
    print(f"   +Shrinkage: {result['agents_b_final']} agent")
    
    print(f"\nğŸ”¹ TOPLAM:")
    print(f"   Toplam Ã‡aÄŸrÄ±: {result['calls_a'] + result['calls_b']}")
    print(f"   Toplam Agent: {result['total_agents']}")
    
    # Test 2: DÃ¼ÅŸÃ¼k yoÄŸun
    print("\n\n" + "=" * 60)
    print("TEST 2: DÃœÅÃœK YOÄUN")
    print("=" * 60)
    result2 = calculate_single_interval(calls_a=20, calls_b=10)
    print(f"A: {result2['calls_a']} Ã§aÄŸrÄ± â†’ {result2['agents_a_final']} agent")
    print(f"B: {result2['calls_b']} Ã§aÄŸrÄ± â†’ {result2['agents_b_final']} agent")
    print(f"Toplam: {result2['total_agents']} agent")
    
    # Test 3: YÃ¼ksek yoÄŸun
    print("\n" + "=" * 60)
    print("TEST 3: YÃœKSEK YOÄUN")
    print("=" * 60)
    result3 = calculate_single_interval(calls_a=100, calls_b=60)
    print(f"A: {result3['calls_a']} Ã§aÄŸrÄ± â†’ {result3['agents_a_final']} agent")
    print(f"B: {result3['calls_b']} Ã§aÄŸrÄ± â†’ {result3['agents_b_final']} agent")
    print(f"Toplam: {result3['total_agents']} agent")
    
    print("\n" + "=" * 60)
    print("ğŸ’¡ Ã–ÄRENME:")
    print("  Bu fonksiyon TEK BÄ°R zaman dilimi iÃ§in hesaplÄ±yor")
    print("  GerÃ§ek projede: 48 interval var (24 saat Ã— 2)")
    print("  Hepsini tek tek hesaplayacaÄŸÄ±z")
    print("=" * 60)
    print("\nâ¡ï¸ Sonraki: TÃ¼m gÃ¼n iÃ§in hesaplama (DataFrame ile)")
