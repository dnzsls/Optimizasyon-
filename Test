"""
FONKSÄ°YON 7: TÃ¼m GÃ¼n iÃ§in Hesaplama (DataFrame)
Kendi DataFrame'inle Ã§alÄ±ÅŸ - 48 interval birden!
"""
import pandas as pd
import math

def erlang_c(agents, traffic):
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)

def calculate_asa(agents, traffic, aht):
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa

def find_agents_for_target(calls, interval_min, aht, target_asa):
    if calls == 0:
        return 0
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    return max_agents


def calculate_full_day(df, interval_min=30, aht=180, target_asa=30, shrinkage=0.10):
    """
    TÃ¼m gÃ¼n iÃ§in agent hesapla
    
    DataFrame formatÄ±:
    - time: '00:00', '00:30', '01:00', ...
    - queue_a: A kuyruÄŸu Ã§aÄŸrÄ± sayÄ±sÄ±
    - queue_b: B kuyruÄŸu Ã§aÄŸrÄ± sayÄ±sÄ±
    
    BAÄIMSIZ yaklaÅŸÄ±m (yardÄ±mlaÅŸma yok)
    
    DÃ¶nÃ¼ÅŸ:
    - Yeni DataFrame (time, calls, agents, traffic)
    """
    results = []
    
    for idx, row in df.iterrows():
        time = row['time']
        calls_a = row['queue_a']
        calls_b = row['queue_b']
        
        # A kuyruÄŸu
        traffic_a = (calls_a * (aht/60)) / interval_min if calls_a > 0 else 0
        agents_a_raw = find_agents_for_target(calls_a, interval_min, aht, target_asa)
        agents_a_final = math.ceil(agents_a_raw / (1 - shrinkage))
        
        # B kuyruÄŸu
        traffic_b = (calls_b * (aht/60)) / interval_min if calls_b > 0 else 0
        agents_b_raw = find_agents_for_target(calls_b, interval_min, aht, target_asa)
        agents_b_final = math.ceil(agents_b_raw / (1 - shrinkage))
        
        results.append({
            'time': time,
            'calls_a': calls_a,
            'calls_b': calls_b,
            'traffic_a': round(traffic_a, 2),
            'traffic_b': round(traffic_b, 2),
            'agents_a': agents_a_final,
            'agents_b': agents_b_final,
            'total_agents': agents_a_final + agents_b_final
        })
    
    return pd.DataFrame(results)


# TEST EDELÄ°M - KENDÄ° VERÄ°NLE Ã‡ALIÅIR!
if __name__ == '__main__':
    print("=" * 60)
    print("FONKSÄ°YON 7: TÃœM GÃœN HESAPLAMA")
    print("=" * 60)
    
    # Ã–rnek veri oluÅŸtur (senin verin bÃ¶yle olacak)
    sample_data = pd.DataFrame({
        'time': ['00:00', '00:30', '01:00', '01:30', '08:00', '08:30', 
                 '09:00', '09:30', '17:00', '17:30', '23:00', '23:30'],
        'queue_a': [5, 5, 5, 5, 30, 40, 50, 55, 35, 30, 10, 8],
        'queue_b': [3, 3, 3, 3, 15, 20, 30, 35, 20, 15, 5, 4]
    })
    
    print("\nğŸ“‹ Ã–rnek Veri (ilk 6 satÄ±r):")
    print(sample_data.head(6))
    
    # Hesapla
    print("\nâš™ï¸ Hesaplama yapÄ±lÄ±yor...")
    result = calculate_full_day(sample_data)
    
    # SonuÃ§larÄ± gÃ¶ster
    print("\n" + "=" * 60)
    print("ğŸ“Š SONUÃ‡LAR")
    print("=" * 60)
    print("\nTÃ¼m sonuÃ§lar:")
    print(result.to_string(index=False))
    
    # Ã–zet istatistikler
    print("\n" + "=" * 60)
    print("ğŸ“ˆ Ã–ZET")
    print("=" * 60)
    print(f"Toplam Ã‡aÄŸrÄ± A: {result['calls_a'].sum()}")
    print(f"Toplam Ã‡aÄŸrÄ± B: {result['calls_b'].sum()}")
    print(f"Peak Saat: {result.loc[result['total_agents'].idxmax(), 'time']}")
    print(f"Peak Agent: {result['total_agents'].max()}")
    print(f"Ortalama Agent: {result['total_agents'].mean():.1f}")
    
    # Peak saat detayÄ±
    peak_idx = result['total_agents'].idxmax()
    peak_row = result.iloc[peak_idx]
    
    print(f"\nğŸ” Peak Saat DetayÄ± ({peak_row['time']}):")
    print(f"  A: {peak_row['calls_a']} Ã§aÄŸrÄ± â†’ {peak_row['agents_a']} agent")
    print(f"  B: {peak_row['calls_b']} Ã§aÄŸrÄ± â†’ {peak_row['agents_b']} agent")
    print(f"  Toplam: {peak_row['total_agents']} agent")
    
    print("\n" + "=" * 60)
    print("âœ… BU FONKSÄ°YON KENDÄ° VERÄ°NLE Ã‡ALIÅIR!")
    print("=" * 60)
    print("\nKullanÄ±m:")
    print("  df = pd.read_excel('cagrilar.xlsx')")
    print("  result = calculate_full_day(df)")
    print("  result.to_excel('agent_ihtiyaci.xlsx')")
