def calculate_weekday_staffing(df: pd.DataFrame) -> pd.DataFrame:
    """
    HAFTA Ä°Ã‡Ä° (POOLED) MANTIK:
      - B ajanlarÄ± kendi B Ã§aÄŸrÄ±larÄ±nÄ± garanti eder (b_min).
      - A+B Ã§aÄŸrÄ±larÄ± tek havuz gibi ele alÄ±nÄ±r -> toplam gerek (n_total).
      - Toplam ajan = max(n_total, b_min).
      - Atama: B = b_min, A = toplam - b_min (negatifse 0).
      - Shrinkage Ã§aÄŸrÄ± sonrasÄ± uygulanÄ±r.
    VarsayÄ±m: AHT ve hedefler (ASA/SL) kuyruklar arasÄ±nda aynÄ±dÄ±r.
    """
    results = []
    for _, row in df.iterrows():
        calls_a = int(row['queue_a'])
        calls_b = int(row['queue_b'])

        # 1) B kuyruÄŸu iÃ§in minimum ajan (B kendi SLA/ASA hedefini garanti eder)
        b_min = calculate_agents(
            calls_b,
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa'],
            CONFIG['target_sl']
        )

        # 2) A+B toplam trafik iÃ§in "tek havuz" gerek
        n_total = calculate_agents(
            calls_a + calls_b,
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa'],
            CONFIG['target_sl']
        )

        # 3) Toplam = max(n_total, b_min)  (Bâ€™nin SLAâ€™sÄ± garanti; havuz Aâ€™yÄ± da kapsar)
        total_core = max(n_total, b_min)

        # 4) Havuzdan atama: Ã¶nce Bâ€™yi doldur, kalan Aâ€™ya gider
        core_b = b_min
        core_a = max(0, total_core - core_b)

        # 5) Shrinkage uygula
        final_a = math.ceil(core_a / (1 - CONFIG['shrinkage'])) if core_a > 0 else 0
        final_b = math.ceil(core_b / (1 - CONFIG['shrinkage'])) if core_b > 0 else 0

        results.append({
            'time': row['time'],
            'queue_a_calls': calls_a,
            'queue_b_calls': calls_b,
            'agents_a': final_a,
            'agents_b': final_b,
            'total_agents': final_a + final_b
        })

    return pd.DataFrame(results)
xxxxxxx
# -*- coding: utf-8 -*-
import pandas as pd
import math

# -----------------------------
# KonfigÃ¼rasyon
# -----------------------------
CONFIG = {
    'aht': 188,          # Average Handle Time (saniye)
    'target_sl': 0.80,   # Servis seviyesi hedefi (Ã¶rn. %80)
    'target_asa': 30,    # Ortalama cevap hÄ±zÄ± hedefi (saniye)
    'shrinkage': 0.10,   # Mola/eÄŸitim/izin oranÄ±
    'interval_minutes': 30
}

# -----------------------------
# Vardiya tanÄ±mlarÄ±
# -----------------------------
SHIFTS = [
    {'name': 'V1',  'start': '07:00', 'end': '16:00', 'duration': 9},
    {'name': 'V2',  'start': '08:00', 'end': '17:00', 'duration': 9},
    {'name': 'V3',  'start': '09:00', 'end': '18:00', 'duration': 9},
    {'name': 'V4',  'start': '10:00', 'end': '19:00', 'duration': 9},
    {'name': 'V5',  'start': '15:00', 'end': '24:00', 'duration': 9},
    {'name': 'V6',  'start': '17:00', 'end': '01:00', 'duration': 8, 'overnight': True},
    {'name': 'V7',  'start': '18:00', 'end': '02:00', 'duration': 8, 'overnight': True},
    {'name': 'V8',  'start': '19:00', 'end': '03:00', 'duration': 8, 'overnight': True},
    {'name': 'V9',  'start': '00:00', 'end': '08:00', 'duration': 8},
    {'name': 'V10', 'start': '08:00', 'end': '17:30', 'duration': 9.5},
    {'name': 'V11', 'start': '09:00', 'end': '18:30', 'duration': 9.5},
    {'name': 'V12', 'start': '10:00', 'end': '19:30', 'duration': 9.5},
    {'name': 'V13', 'start': '11:00', 'end': '20:30', 'duration': 9.5},
    {'name': 'V14', 'start': '12:00', 'end': '21:30', 'duration': 9.5},
    {'name': 'V15', 'start': '13:00', 'end': '22:30', 'duration': 9.5},
    {'name': 'V16', 'start': '14:00', 'end': '23:30', 'duration': 9.5},
    {'name': 'V17', 'start': '15:00', 'end': '00:30', 'duration': 9.5, 'overnight': True},
    {'name': 'V18', 'start': '17:00', 'end': '01:30', 'duration': 8.5, 'overnight': True},
    {'name': 'V19', 'start': '18:00', 'end': '02:30', 'duration': 8.5, 'overnight': True},
]

# -----------------------------
# Erlang-C yardÄ±mcÄ±larÄ±
# -----------------------------
def erlang_c_wait_prob(n_agents: int, traffic_erlangs: float) -> float:
    """
    Erlang C (M/M/n) bekleme olasÄ±lÄ±ÄŸÄ± P(wait>0).
    P0 = [ Î£_{k=0}^{n-1} (a^k/k!) + (a^n/n!)*(n/(n-a)) ]^-1
    ErlangC = (a^n/n!)*(n/(n-a))*P0
    """
    a = float(traffic_erlangs)
    n = int(n_agents)
    if n <= 0:
        return 1.0
    if a <= 0.0:
        return 0.0
    if a >= n:
        return 1.0

    # k=0..n-1 iÃ§in seri toplamÄ± ve a^n/n! terimi
    term = 1.0                 # a^0/0!
    summation = term
    for k in range(1, n):
        term *= a / k          # a^k/k!
        summation += term

    # a^n/n!
    term *= a / n

    denom = summation + term * (n / (n - a))
    if denom == 0:
        return 1.0
    p0 = 1.0 / denom
    ec = term * (n / (n - a)) * p0
    return min(max(ec, 0.0), 1.0)


def asa_seconds(n_agents: int, traffic_erlangs: float, aht_seconds: float) -> float:
    """ASA = (ErlangC * AHT) / (n - a)"""
    a = float(traffic_erlangs)
    n = int(n_agents)
    if n <= a or n <= 0:
        return float('inf')
    ec = erlang_c_wait_prob(n, a)
    return (ec * aht_seconds) / (n - a)


def service_level(n_agents: int, traffic_erlangs: float, aht_seconds: float, target_seconds: float) -> float:
    """
    SL â‰ˆ 1 - P(wait > T)
    P(wait > T) â‰ˆ ErlangC * exp(-(n-a) * T / AHT)
    """
    a = float(traffic_erlangs)
    n = int(n_agents)
    if n <= a or n <= 0:
        return 0.0
    ec = erlang_c_wait_prob(n, a)
    pw_gt_t = ec * math.exp(-(n - a) * (target_seconds / aht_seconds))
    sl = 1.0 - pw_gt_t
    return max(0.0, min(1.0, sl))


def calls_to_erlangs(calls: float, interval_minutes: float, aht_seconds: float) -> float:
    """
    a (erlang) = (calls / (interval_minutes*60)) * AHT
    """
    if calls <= 0 or interval_minutes <= 0 or aht_seconds <= 0:
        return 0.0
    lam = calls / (interval_minutes * 60.0)  # saniyede Ã§aÄŸrÄ±
    return lam * aht_seconds

# -----------------------------
# Agent hesaplayÄ±cÄ±
# -----------------------------
def calculate_agents(calls: int, interval_min: int, aht: int, target_asa: int, target_sl: float) -> int:
    """
    Minimum agent sayÄ±sÄ±nÄ± bulur.
    KoÅŸullar: ASA â‰¤ target_asa VE SL â‰¥ target_sl
    """
    if calls <= 0:
        return 0

    a = calls_to_erlangs(calls, interval_min, aht)
    if a == 0:
        return 0

    n_min = max(1, math.ceil(a))
    n_max = max(n_min + 1, math.ceil(3 * a) + 10)

    chosen = n_max
    for n in range(n_min, n_max + 1):
        asa = asa_seconds(n, a, aht)
        sl = service_level(n, a, aht, target_asa)
        if (asa <= target_asa) and (sl >= target_sl):
            chosen = n
            break
    return chosen

# -----------------------------
# Ã–rnek veri Ã¼retimi
# -----------------------------
def generate_sample_data(is_weekend: bool = False) -> pd.DataFrame:
    """
    24 saatlik (00:00..23:30) 30 dakikalÄ±k slotlarda Ã¶rnek Ã§aÄŸrÄ± verisi.
    is_weekend=True ise %60 Ã§arpanÄ± uygulanÄ±r.
    """
    multiplier = 0.6 if is_weekend else 1.0
    rows = []
    for hour in range(24):
        for minute in (0, 30):
            t = f"{hour:02d}:{minute:02d}"
            if 8 <= hour <= 16:       # GÃ¼ndÃ¼z tepe
                base_a = 80 + (hour - 8) * 5
                base_b = 30 + (hour - 8) * 2
            elif 17 <= hour <= 22:    # AkÅŸam
                base_a = 70 - (hour - 17) * 10
                base_b = 25 - (hour - 17) * 4
            else:                     # Gece
                base_a = 5
                base_b = 2
            rows.append({
                'time': t,
                'queue_a': int(round(base_a * multiplier)),
                'queue_b': int(round(base_b * multiplier)),
            })
    return pd.DataFrame(rows)

# -----------------------------
# Hafta iÃ§i / Hafta sonu hesaplarÄ±
# -----------------------------
def calculate_weekday_staffing(df: pd.DataFrame) -> pd.DataFrame:
    """
    Hafta iÃ§i:
      - B kuyruÄŸu: sadece B agentlarÄ±
      - A kuyruÄŸu: A Ã§aÄŸrÄ±larÄ± (A+B servis edebilir) â€” konservatif olarak ayrÄ± hesap
      - Shrinkage uygulanÄ±r
    """
    results = []
    for _, row in df.iterrows():
        agents_b = calculate_agents(int(row['queue_b']),
                                    CONFIG['interval_minutes'],
                                    CONFIG['aht'],
                                    CONFIG['target_asa'],
                                    CONFIG['target_sl'])
        agents_a = calculate_agents(int(row['queue_a']),
                                    CONFIG['interval_minutes'],
                                    CONFIG['aht'],
                                    CONFIG['target_asa'],
                                    CONFIG['target_sl'])

        final_a = math.ceil(agents_a / (1 - CONFIG['shrinkage']))
        final_b = math.ceil(agents_b / (1 - CONFIG['shrinkage']))

        results.append({
            'time': row['time'],
            'queue_a_calls': int(row['queue_a']),
            'queue_b_calls': int(row['queue_b']),
            'agents_a': final_a,
            'agents_b': final_b,
            'total_agents': final_a + final_b
        })
    return pd.DataFrame(results)


def calculate_weekend_staffing(df: pd.DataFrame) -> pd.DataFrame:
    """
    Hafta sonu:
      - Kuyruklar baÄŸÄ±msÄ±z, yardÄ±m yok
      - Shrinkage uygulanÄ±r
    """
    results = []
    for _, row in df.iterrows():
        agents_a = calculate_agents(int(row['queue_a']),
                                    CONFIG['interval_minutes'],
                                    CONFIG['aht'],
                                    CONFIG['target_asa'],
                                    CONFIG['target_sl'])
        agents_b = calculate_agents(int(row['queue_b']),
                                    CONFIG['interval_minutes'],
                                    CONFIG['aht'],
                                    CONFIG['target_asa'],
                                    CONFIG['target_sl'])

        final_a = math.ceil(agents_a / (1 - CONFIG['shrinkage']))
        final_b = math.ceil(agents_b / (1 - CONFIG['shrinkage']))

        results.append({
            'time': row['time'],
            'queue_a_calls': int(row['queue_a']),
            'queue_b_calls': int(row['queue_b']),
            'agents_a': final_a,
            'agents_b': final_b,
            'total_agents': final_a + final_b
        })
    return pd.DataFrame(results)

# -----------------------------
# Vardiya kapsama
# -----------------------------
def is_time_in_shift(time_str: str, shift: dict) -> bool:
    """'HH:MM' zamanÄ±, vardiyanÄ±n baÅŸlangÄ±Ã§-bitiÅŸi arasÄ±nda mÄ±? (overnight destekli)"""
    h, m = map(int, time_str.split(':'))
    tmin = h * 60 + m

    sh, sm = map(int, shift['start'].split(':'))
    smin = sh * 60 + sm

    eh, em = map(int, shift['end'].split(':'))
    emin = eh * 60 + em

    # Overnight vardiyalarda bitiÅŸ ertesi gÃ¼ne taÅŸÄ±yabilir
    if shift.get('overnight', False) and emin <= smin:
        emin += 24 * 60
        if tmin < smin:
            tmin += 24 * 60

    return smin <= tmin < emin


def calculate_shift_requirements(weekday_df: pd.DataFrame, weekend_df: pd.DataFrame) -> pd.DataFrame:
    """Her vardiya iÃ§in hafta iÃ§i/sonu maksimum toplam agent ihtiyacÄ±."""
    rows = []
    for shift in SHIFTS:
        wd = weekday_df[weekday_df['time'].apply(lambda x: is_time_in_shift(x, shift))]
        we = weekend_df[weekend_df['time'].apply(lambda x: is_time_in_shift(x, shift))]
        wd_max = int(wd['total_agents'].max()) if len(wd) else 0
        we_max = int(we['total_agents'].max()) if len(we) else 0

        rows.append({
            'shift_name': shift['name'],
            'start_time': shift['start'],
            'end_time': shift['end'],
            'duration_hours': shift['duration'],
            'weekday_agents_needed': wd_max,
            'weekend_agents_needed': we_max
        })
    return pd.DataFrame(rows)

# -----------------------------
# Kendi verisiyle Ã§alÄ±ÅŸtÄ±rma
# -----------------------------
def calculate_with_custom_data(df_weekday: pd.DataFrame, df_weekend: pd.DataFrame = None):
    print("\nğŸ“Š Kendi verinle hesaplama:")
    print(f"Hafta iÃ§i satÄ±r sayÄ±sÄ±: {len(df_weekday)}")

    weekday_staffing = calculate_weekday_staffing(df_weekday)

    if df_weekend is None:
        print("Hafta sonu veri yok, hafta iÃ§inin %60'Ä± tÃ¼retiliyor.")
        df_weekend = df_weekday.copy()
        df_weekend['queue_a'] = (df_weekend['queue_a'] * 0.6).round().astype(int)
        df_weekend['queue_b'] = (df_weekend['queue_b'] * 0.6).round().astype(int)

    weekend_staffing = calculate_weekend_staffing(df_weekend)
    shift_analysis = calculate_shift_requirements(weekday_staffing, weekend_staffing)
    return weekday_staffing, weekend_staffing, shift_analysis

# -----------------------------
# Ana akÄ±ÅŸ
# -----------------------------
def main():
    print("=" * 80)
    print("Ã‡AÄRI MERKEZÄ° KAPASÄ°TE PLANLAMA ANALÄ°ZÄ°")
    print("=" * 80)
    print("\nKonfigÃ¼rasyon:")
    print(f"  - AHT: {CONFIG['aht']} sn")
    print(f"  - Hedef SL: {int(CONFIG['target_sl']*100)}%")
    print(f"  - Hedef ASA: {CONFIG['target_asa']} sn")
    print(f"  - Shrinkage: {int(CONFIG['shrinkage']*100)}%")
    print("\n" + "=" * 80)

    # 1) Ã–rnek veri
    print("[1/4] Ã–rnek Ã§aÄŸrÄ± verileri oluÅŸturuluyor...")
    weekday_calls = generate_sample_data(is_weekend=False)
    weekend_calls = generate_sample_data(is_weekend=True)

    # 2) Hafta iÃ§i
    print("[2/4] Hafta iÃ§i agent ihtiyacÄ± hesaplanÄ±yor...")
    weekday_staffing = calculate_weekday_staffing(weekday_calls)

    # 3) Hafta sonu
    print("[3/4] Hafta sonu agent ihtiyacÄ± hesaplanÄ±yor...")
    weekend_staffing = calculate_weekend_staffing(weekend_calls)

    # 4) Vardiya analizi
    print("[4/4] Vardiya bazlÄ± analiz...")
    shifts = calculate_shift_requirements(weekday_staffing, weekend_staffing)

    # Ã–zetler
    print("\n" + "=" * 80)
    print("ğŸ“Š HAFTA Ä°Ã‡Ä° Ã–ZET")
    print("-" * 80)
    total_calls_wd = int(weekday_staffing['queue_a_calls'].sum() + weekday_staffing['queue_b_calls'].sum())
    print(f"Toplam GÃ¼nlÃ¼k Ã‡aÄŸrÄ±: {total_calls_wd}")
    print(f"  - A KuyruÄŸu: {int(weekday_staffing['queue_a_calls'].sum())}")
    print(f"  - B KuyruÄŸu: {int(weekday_staffing['queue_b_calls'].sum())}")
    print(f"Peak Agent Ä°htiyacÄ±: {int(weekday_staffing['total_agents'].max())}")
    print(f"  - A AgentlarÄ± (peak): {int(weekday_staffing['agents_a'].max())}")
    print(f"  - B AgentlarÄ± (peak): {int(weekday_staffing['agents_b'].max())}")
    print(f"Ortalama Agent Ä°htiyacÄ±: {weekday_staffing['total_agents'].mean():.1f}")
    print(f"Peak Saati: {weekday_staffing.loc[weekday_staffing['total_agents'].idxmax(), 'time']}")

    print("\nğŸ“Š HAFTA SONU Ã–ZET")
    print("-" * 80)
    total_calls_we = int(weekend_staffing['queue_a_calls'].sum() + weekend_staffing['queue_b_calls'].sum())
    print(f"Toplam GÃ¼nlÃ¼k Ã‡aÄŸrÄ±: {total_calls_we}")
    print(f"  - A KuyruÄŸu: {int(weekend_staffing['queue_a_calls'].sum())}")
    print(f"  - B KuyruÄŸu: {int(weekend_staffing['queue_b_calls'].sum())}")
    print(f"Peak Agent Ä°htiyacÄ±: {int(weekend_staffing['total_agents'].max())}")
    print(f"  - A AgentlarÄ± (peak): {int(weekend_staffing['agents_a'].max())}")
    print(f"  - B AgentlarÄ± (peak): {int(weekend_staffing['agents_b'].max())}")
    print(f"Ortalama Agent Ä°htiyacÄ±: {weekend_staffing['total_agents'].mean():.1f}")
    print(f"Peak Saati: {weekend_staffing.loc[weekend_staffing['total_agents'].idxmax(), 'time']}")

    # Excel'e kaydet (opsiyonel)
    out_path = "call_center_staffing_plan.xlsx"
    try:
        with pd.ExcelWriter(out_path, engine='openpyxl') as writer:
            weekday_staffing.to_excel(writer, sheet_name='Hafta_Ici', index=False)
            weekend_staffing.to_excel(writer, sheet_name='Hafta_Sonu', index=False)
            shifts.to_excel(writer, sheet_name='Vardiya_Plani', index=False)
        print(f"\nâœ… Excel kaydedildi: {out_path}")
    except Exception as e:
        print(f"\nâš ï¸ Excel kaydetme hatasÄ±: {e}\nNot: openpyxl kurulu deÄŸilse: pip install openpyxl")

    return weekday_staffing, weekend_staffing, shifts

if __name__ == "__main__":
    weekday_df, weekend_df, shifts_df = main()
