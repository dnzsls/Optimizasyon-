"""
19 Vardiya ile Kapasite Planlama
YardÄ±mlaÅŸma YOK - BaÄŸÄ±msÄ±z hesaplama
"""
import pandas as pd
import math

# ============= TEMEL FONKSÄ°YONLAR =============

def erlang_c(agents, traffic):
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)

def calculate_asa(agents, traffic, aht):
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa

def find_agents_for_target(calls, interval_min, aht, target_asa):
    if calls == 0:
        return 0
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    return max_agents

def time_to_minutes(time_str):
    """'07:30' â†’ 450 dakika"""
    h, m = map(int, time_str.split(':'))
    return h * 60 + m

def is_time_in_shift(time_str, shift_start, shift_end):
    """Bir zaman vardiya iÃ§inde mi kontrol et (gece vardiyasÄ± dahil)"""
    time_min = time_to_minutes(time_str)
    start_min = time_to_minutes(shift_start)
    end_min = time_to_minutes(shift_end)
    
    if end_min <= start_min:  # Gece vardiyasÄ±
        return time_min >= start_min or time_min < end_min
    else:  # Normal vardiya
        return start_min <= time_min < end_min


# ============= 19 VARDÄ°YA TANIMI =============

# A21 Firma VardiyalarÄ± (Sol kolon)
SHIFTS_A21 = [
    {'name': 'V1', 'start': '07:00', 'end': '16:00', 'duration': 9.0},
    {'name': 'V2', 'start': '08:00', 'end': '17:00', 'duration': 9.0},
    {'name': 'V3', 'start': '09:00', 'end': '18:00', 'duration': 9.0},
    {'name': 'V4', 'start': '10:00', 'end': '19:00', 'duration': 9.0},
    {'name': 'V5', 'start': '15:00', 'end': '24:00', 'duration': 9.0},
    {'name': 'V6', 'start': '17:00', 'end': '01:00', 'duration': 8.0},
    {'name': 'V7', 'start': '18:00', 'end': '02:00', 'duration': 8.0},
    {'name': 'V8', 'start': '19:00', 'end': '03:00', 'duration': 8.0},
    {'name': 'V9', 'start': '00:00', 'end': '08:00', 'duration': 8.0},
]

# B21 Firma VardiyalarÄ± (SaÄŸ kolon - buÃ§uklu saatler)
SHIFTS_B21 = [
    {'name': 'V10', 'start': '08:00', 'end': '17:30', 'duration': 9.5},
    {'name': 'V11', 'start': '09:00', 'end': '18:30', 'duration': 9.5},
    {'name': 'V12', 'start': '10:00', 'end': '19:30', 'duration': 9.5},
    {'name': 'V13', 'start': '11:00', 'end': '20:30', 'duration': 9.5},
    {'name': 'V14', 'start': '12:00', 'end': '21:30', 'duration': 9.5},
    {'name': 'V15', 'start': '13:00', 'end': '22:30', 'duration': 9.5},
    {'name': 'V16', 'start': '14:00', 'end': '23:30', 'duration': 9.5},
    {'name': 'V17', 'start': '15:00', 'end': '00:30', 'duration': 9.5},
    {'name': 'V18', 'start': '17:00', 'end': '01:30', 'duration': 8.5},
    {'name': 'V19', 'start': '18:00', 'end': '02:30', 'duration': 8.5},
]

ALL_SHIFTS = SHIFTS_A21 + SHIFTS_B21


# ============= INTERVAL BAZLI Ä°HTÄ°YAÃ‡ =============

def calculate_interval_requirements(df, interval_min=30, aht=180, 
                                    target_asa=30, shrinkage=0.10):
    """Her interval iÃ§in agent ihtiyacÄ± (BAÄIMSIZ)"""
    results = []
    
    for idx, row in df.iterrows():
        calls_a = row['queue_a']
        calls_b = row['queue_b']
        
        # A iÃ§in
        agents_a_raw = find_agents_for_target(calls_a, interval_min, aht, target_asa)
        agents_a_final = math.ceil(agents_a_raw / (1 - shrinkage))
        
        # B iÃ§in
        agents_b_raw = find_agents_for_target(calls_b, interval_min, aht, target_asa)
        agents_b_final = math.ceil(agents_b_raw / (1 - shrinkage))
        
        results.append({
            'time': row['time'],
            'calls_a': calls_a,
            'calls_b': calls_b,
            'agents_a': agents_a_final,
            'agents_b': agents_b_final,
            'total_agents': agents_a_final + agents_b_final
        })
    
    return pd.DataFrame(results)


# ============= VARDÄ°YA BAZLI Ä°HTÄ°YAÃ‡ =============

def calculate_shift_requirements(interval_df, shifts):
    """Vardiya bazlÄ± agent ihtiyacÄ±"""
    shift_results = []
    
    for shift in shifts:
        shift_intervals = interval_df[
            interval_df['time'].apply(
                lambda t: is_time_in_shift(t, shift['start'], shift['end'])
            )
        ]
        
        if len(shift_intervals) == 0:
            agents_a = 0
            agents_b = 0
            max_total = 0
        else:
            agents_a = shift_intervals['agents_a'].max()
            agents_b = shift_intervals['agents_b'].max()
            max_total = shift_intervals['total_agents'].max()
        
        shift_results.append({
            'shift': shift['name'],
            'start': shift['start'],
            'end': shift['end'],
            'duration': shift['duration'],
            'agents_a': int(agents_a),
            'agents_b': int(agents_b),
            'total': int(max_total),
            'intervals': len(shift_intervals)
        })
    
    return pd.DataFrame(shift_results)


# ============= ANA FONKSÄ°YON =============

def calculate_all(df):
    """TÃ¼m hesaplama - Interval ve Vardiya"""
    
    print("=" * 70)
    print("KAPASÄ°TE PLANLAMA - 19 VARDÄ°YA")
    print("=" * 70)
    
    # ADIM 1: Interval bazlÄ±
    print("\nâš™ï¸ ADIM 1: Interval bazlÄ± hesaplama...")
    interval_req = calculate_interval_requirements(df)
    
    print(f"âœ… {len(interval_req)} interval hesaplandÄ±")
    print(f"   Peak: {interval_req['total_agents'].max()} agent")
    print(f"   Peak Saat: {interval_req.loc[interval_req['total_agents'].idxmax(), 'time']}")
    
    # ADIM 2: Vardiya bazlÄ±
    print("\nâš™ï¸ ADIM 2: Vardiya bazlÄ± hesaplama...")
    shift_req = calculate_shift_requirements(interval_req, ALL_SHIFTS)
    
    # SÄ±fÄ±r agentli vardiyalarÄ± filtrele
    shift_req_active = shift_req[shift_req['total'] > 0]
    
    print(f"âœ… {len(shift_req_active)} aktif vardiya bulundu")
    print(f"   (Toplam 19 vardiyadan {len(shift_req) - len(shift_req_active)} boÅŸ)")
    
    return interval_req, shift_req, shift_req_active


# ============= TEST =============

if __name__ == '__main__':
    
    # Ã–rnek veri (24 saat, 30dk interval = 48 satÄ±r)
    times = pd.date_range('00:00', '23:30', freq='30min').strftime('%H:%M')
    
    # GerÃ§ekÃ§i pattern
    sample_data = pd.DataFrame({
        'time': times,
        'queue_a': [
            # 00:00-06:00 (Gece - az)
            5,5,5,5,5,5,8,8,10,10,12,12,
            # 06:00-12:00 (Sabah - artÄ±yor)
            20,25,30,40,50,55,60,60,58,56,54,52,
            # 12:00-18:00 (Ã–ÄŸle-AkÅŸam - yÃ¼ksek)
            50,48,46,44,50,55,60,58,56,54,52,50,
            # 18:00-24:00 (Gece - azalÄ±yor)
            45,40,35,30,25,20,15,12,10,8,6,5
        ],
        'queue_b': [
            # 00:00-06:00
            3,3,3,3,3,3,5,5,6,6,8,8,
            # 06:00-12:00
            10,12,15,20,25,28,30,30,29,28,27,26,
            # 12:00-18:00
            25,24,23,22,25,28,30,29,28,27,26,25,
            # 18:00-24:00
            22,20,18,15,12,10,8,6,5,4,3,3
        ]
    })
    
    # Hesapla
    interval_req, shift_req_all, shift_req_active = calculate_all(sample_data)
    
    # SonuÃ§larÄ± gÃ¶ster
    print("\n" + "=" * 70)
    print("ğŸ“Š VARDÄ°YA SONUÃ‡LARI (Aktif Vardiyalar)")
    print("=" * 70)
    print(shift_req_active.to_string(index=False))
    
    # A21 vs B21 ayrÄ±mÄ±
    print("\n" + "=" * 70)
    print("ğŸ“Š FÄ°RMA BAZLI DAÄILIM")
    print("=" * 70)
    
    a21_shifts = shift_req_active[shift_req_active['shift'].isin([s['name'] for s in SHIFTS_A21])]
    b21_shifts = shift_req_active[shift_req_active['shift'].isin([s['name'] for s in SHIFTS_B21])]
    
    print(f"\nğŸ¢ A21 Firma VardiyalarÄ±: {len(a21_shifts)} aktif")
    print(f"   Toplam Agent: {a21_shifts['total'].sum()}")
    
    print(f"\nğŸ¢ B21 Firma VardiyalarÄ±: {len(b21_shifts)} aktif")
    print(f"   Toplam Agent: {b21_shifts['total'].sum()}")
    
    print("\n" + "=" * 70)
    print("âœ… AÅAMA 1 TAMAMLANDI")
    print("=" * 70)
    print("Sonraki adÄ±mlar:")
    print("  1. Mola planlamasÄ±")
    print("  2. Firma kÄ±rÄ±lÄ±mÄ± (A21 %30 B-capable)")
    print("  3. YardÄ±mlaÅŸma mantÄ±ÄŸÄ±")
