"""
Interval BazlÄ± Agent Hesaplama - YardÄ±mlaÅŸmalÄ±
B agentlarÄ± B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar, boÅŸ kalÄ±rsa A'ya yardÄ±m eder
"""
import pandas as pd
import math

# ============= TEMEL FONKSÄ°YONLAR =============

def erlang_c(agents, traffic):
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)

def calculate_asa(agents, traffic, aht):
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa

def find_agents_for_target(calls, interval_min, aht, target_asa):
    if calls == 0:
        return 0
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    return max_agents


# ============= YARDIMLAÅMALI HESAPLAMA =============

def calculate_with_support_single(calls_a, calls_b, interval_min=30, aht=180, 
                                   target_asa=30, shrinkage=0.10):
    """
    Tek interval iÃ§in yardÄ±mlaÅŸmalÄ± agent hesaplama
    
    MantÄ±k:
    1. B Ã§aÄŸrÄ±larÄ± iÃ§in gereken B agent sayÄ±sÄ±nÄ± bul
    2. Toplam (A+B) Ã§aÄŸrÄ±larÄ± iÃ§in gereken B agent sayÄ±sÄ±nÄ± bul
    3. EÄŸer toplam iÃ§in gereken â‰¤ B iÃ§in gereken:
       â†’ B agentlarÄ± yeterli, A agentÄ± gerekmez
    4. DeÄŸilse:
       â†’ B agentlarÄ± sadece B'yi karÅŸÄ±lar
       â†’ A Ã§aÄŸrÄ±larÄ± iÃ§in A agentÄ± gerek
    """
    
    # 1. B Ã§aÄŸrÄ±larÄ± iÃ§in B agent
    b_agents_for_b = find_agents_for_target(calls_b, interval_min, aht, target_asa)
    
    # 2. Toplam Ã§aÄŸrÄ± iÃ§in B agent
    total_calls = calls_a + calls_b
    b_agents_for_all = find_agents_for_target(total_calls, interval_min, aht, target_asa)
    
    # 3. Karar
    if b_agents_for_all <= b_agents_for_b:
        # B agentlarÄ± hem A hem B'yi karÅŸÄ±lar
        agents_b_raw = b_agents_for_all
        agents_a_raw = 0
        b_helps = True
    else:
        # B sadece B'yi karÅŸÄ±lar, A iÃ§in ayrÄ± agent gerek
        agents_b_raw = b_agents_for_b
        agents_a_raw = find_agents_for_target(calls_a, interval_min, aht, target_asa)
        b_helps = False
    
    # Shrinkage ekle
    agents_a_final = math.ceil(agents_a_raw / (1 - shrinkage)) if agents_a_raw > 0 else 0
    agents_b_final = math.ceil(agents_b_raw / (1 - shrinkage)) if agents_b_raw > 0 else 0
    
    return {
        'agents_a': agents_a_final,
        'agents_b': agents_b_final,
        'total': agents_a_final + agents_b_final,
        'b_helps_a': b_helps
    }


# ============= KARÅILAÅTIRMA =============

def compare_methods_single(calls_a, calls_b):
    """BaÄŸÄ±msÄ±z vs YardÄ±mlaÅŸmalÄ± karÅŸÄ±laÅŸtÄ±r"""
    
    print("=" * 60)
    print("KARÅILAÅTIRMA: BAÄIMSIZ vs YARDIMLAÅMALI")
    print("=" * 60)
    
    print(f"\nğŸ“‹ Ã‡aÄŸrÄ±lar: {calls_a} A + {calls_b} B\n")
    
    # BAÄIMSIZ
    print("â”€" * 60)
    print("YÃ–NTEM 1: BAÄIMSIZ")
    print("â”€" * 60)
    
    a_ind = find_agents_for_target(calls_a, 30, 180, 30)
    b_ind = find_agents_for_target(calls_b, 30, 180, 30)
    a_ind_final = math.ceil(a_ind / 0.9)
    b_ind_final = math.ceil(b_ind / 0.9)
    total_ind = a_ind_final + b_ind_final
    
    print(f"  A agentlarÄ±: {a_ind_final} (sadece A Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar)")
    print(f"  B agentlarÄ±: {b_ind_final} (sadece B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar)")
    print(f"  TOPLAM: {total_ind}")
    
    # YARDIMLAÅMALI
    print("\nâ”€" * 60)
    print("YÃ–NTEM 2: YARDIMLAÅMALI")
    print("â”€" * 60)
    
    result = calculate_with_support_single(calls_a, calls_b)
    
    print(f"  A agentlarÄ±: {result['agents_a']} (sadece A)")
    print(f"  B agentlarÄ±: {result['agents_b']} (B + boÅŸsa A'ya yardÄ±m)")
    print(f"  TOPLAM: {result['total']}")
    print(f"  B yardÄ±m etti mi? {'âœ… Evet' if result['b_helps_a'] else 'âŒ HayÄ±r'}")
    
    # FARK
    print("\nâ”€" * 60)
    print("ğŸ’° TASARRUF")
    print("â”€" * 60)
    
    diff = total_ind - result['total']
    pct = (diff / total_ind * 100) if total_ind > 0 else 0
    
    print(f"  Fark: {diff} agent ({pct:.1f}%)")
    
    if diff > 0:
        print(f"  âœ… {diff} agent tasarruf!")
    elif diff == 0:
        print(f"  âš ï¸ Fark yok (B Ã§aÄŸrÄ±larÄ± Ã§ok fazla)")
    else:
        print(f"  âŒ Hata var!")
    
    return {
        'independent': total_ind,
        'support': result['total'],
        'saving': diff
    }


# ============= TEST =============

if __name__ == '__main__':
    
    # Test 1: B Ã§aÄŸrÄ±larÄ± az
    print("\n" + "=" * 60)
    print("TEST 1: B Ã‡AÄRILARI AZ")
    print("=" * 60)
    compare_methods_single(calls_a=50, calls_b=10)
    
    # Test 2: B Ã§aÄŸrÄ±larÄ± orta
    print("\n\n" + "=" * 60)
    print("TEST 2: B Ã‡AÄRILARI ORTA")
    print("=" * 60)
    compare_methods_single(calls_a=50, calls_b=30)
    
    # Test 3: B Ã§aÄŸrÄ±larÄ± Ã§ok
    print("\n\n" + "=" * 60)
    print("TEST 3: B Ã‡AÄRILARI Ã‡OK")
    print("=" * 60)
    compare_methods_single(calls_a=30, calls_b=50)
    
    print("\n\n" + "=" * 60)
    print("ğŸ’¡ SONUÃ‡:")
    print("=" * 60)
    print("B Ã§aÄŸrÄ±larÄ± az â†’ B agentlarÄ± A'ya yardÄ±m eder â†’ Tasarruf!")
    print("B Ã§aÄŸrÄ±larÄ± Ã§ok â†’ B agentlarÄ± sadece B'yi karÅŸÄ±lar â†’ Tasarruf yok")
    print("\nâ¡ï¸ Sonraki: DataFrame ile tÃ¼m gÃ¼n hesaplama")
