"""
FONKSÄ°YON 4: Hedef ASA iÃ§in Agent SayÄ±sÄ± Bulma
Otomatik olarak kaÃ§ agent gerektiÄŸini bulur
"""
import math

def erlang_c(agents, traffic):
    """Bekleme olasÄ±lÄ±ÄŸÄ±"""
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_asa(agents, traffic, aht):
    """ASA hesapla"""
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa


def find_agents_for_target(calls, interval_min, aht, target_asa):
    """
    Hedef ASA iÃ§in gereken minimum agent sayÄ±sÄ±nÄ± bul
    
    NasÄ±l Ã§alÄ±ÅŸÄ±r?
    1. Traffic hesapla
    2. Minimum agent'tan baÅŸla (= traffic)
    3. Her sayÄ±yÄ± dene, ASA hesapla
    4. Hedefi karÅŸÄ±layan ilk sayÄ±yÄ± dÃ¶ndÃ¼r
    
    Parametreler:
    - calls: Ã‡aÄŸrÄ± sayÄ±sÄ±
    - interval_min: Ä°nterval (dakika)
    - aht: Average Handle Time (saniye)
    - target_asa: Hedef ASA (saniye)
    
    DÃ¶nÃ¼ÅŸ:
    - Gereken agent sayÄ±sÄ±
    """
    if calls == 0:
        return 0
    
    # 1. Traffic hesapla
    traffic = (calls * (aht / 60)) / interval_min
    
    if traffic == 0:
        return 0
    
    # 2. Arama aralÄ±ÄŸÄ±
    min_agents = math.ceil(traffic)  # En az traffic kadar
    max_agents = math.ceil(traffic * 3) + 10  # Ãœst limit
    
    # 3. Her sayÄ±yÄ± dene
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        
        if asa <= target_asa:
            return agents  # Ä°lk karÅŸÄ±layan sayÄ± = optimal
    
    return max_agents  # BulunamadÄ±ysa max dÃ¶ndÃ¼r


# TEST EDELÄ°M
if __name__ == '__main__':
    print("=" * 60)
    print("FONKSÄ°YON 4: OTOMATÄ°K AGENT BULMA")
    print("=" * 60)
    
    # Parametreler
    interval = 30
    aht = 180
    target = 30  # 30 saniye hedef
    
    print(f"\nSabit:")
    print(f"  Ä°nterval: {interval} dakika")
    print(f"  AHT: {aht} saniye")
    print(f"  Hedef ASA: {target} saniye\n")
    
    # Test 1: 50 Ã§aÄŸrÄ±
    calls1 = 50
    traffic1 = (calls1 * (aht/60)) / interval
    agents1 = find_agents_for_target(calls1, interval, aht, target)
    asa1 = calculate_asa(agents1, traffic1, aht)
    
    print(f"Test 1: {calls1} Ã§aÄŸrÄ±")
    print(f"  Traffic: {traffic1:.1f} Erlang")
    print(f"  Bulunan Agent: {agents1}")
    print(f"  GerÃ§ek ASA: {asa1:.1f} saniye")
    print(f"  Hedef karÅŸÄ±landÄ± mÄ±? {'âœ… Evet' if asa1 <= target else 'âŒ HayÄ±r'}")
    
    # Test 2: 100 Ã§aÄŸrÄ±
    calls2 = 100
    traffic2 = (calls2 * (aht/60)) / interval
    agents2 = find_agents_for_target(calls2, interval, aht, target)
    asa2 = calculate_asa(agents2, traffic2, aht)
    
    print(f"\nTest 2: {calls2} Ã§aÄŸrÄ±")
    print(f"  Traffic: {traffic2:.1f} Erlang")
    print(f"  Bulunan Agent: {agents2}")
    print(f"  GerÃ§ek ASA: {asa2:.1f} saniye")
    print(f"  Hedef karÅŸÄ±landÄ± mÄ±? {'âœ… Evet' if asa2 <= target else 'âŒ HayÄ±r'}")
    
    # Test 3: 20 Ã§aÄŸrÄ± (az yoÄŸun)
    calls3 = 20
    traffic3 = (calls3 * (aht/60)) / interval
    agents3 = find_agents_for_target(calls3, interval, aht, target)
    asa3 = calculate_asa(agents3, traffic3, aht)
    
    print(f"\nTest 3: {calls3} Ã§aÄŸrÄ±")
    print(f"  Traffic: {traffic3:.1f} Erlang")
    print(f"  Bulunan Agent: {agents3}")
    print(f"  GerÃ§ek ASA: {asa3:.1f} saniye")
    print(f"  Hedef karÅŸÄ±landÄ± mÄ±? {'âœ… Evet' if asa3 <= target else 'âŒ HayÄ±r'}")
    
    print("\n" + "=" * 60)
    print("ğŸ’¡ Ã–ÄRENME:")
    print("  Bu fonksiyon 'kaÃ§ agent?' sorusunu otomatik cevaplÄ±yor")
    print("  Elle denemeden direkt optimal sayÄ±yÄ± buluyor")
    print("=" * 60)
    print("\nâ¡ï¸ Sonraki: Shrinkage ekleyip tam hesaplama")
