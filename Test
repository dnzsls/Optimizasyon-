"""
KOMPLE KAPASÄ°TE PLANLAMA - V2
Vardiyalar Excel'den okunur, saat bazlÄ± kesiÅŸim
"""
import pandas as pd
import math

# ============= KONFIGURASYON =============

CONFIG = {
    'aht': 180,              # Average Handle Time - saniye
    'target_asa': 30,        # Hedef yanÄ±t sÃ¼resi - saniye
    'shrinkage': 0.10,       # Mola/izin payÄ± - %10
    'interval_minutes': 15   # Ä°nterval - dakika
}


# ============================================================================
# VARDÄ°YA OKUMA (EXCEL'DEN) - ZORUNLU
# ============================================================================

def load_shifts_from_excel(excel_path):
    """
    Excel'den vardiya tanÄ±mlarÄ±nÄ± oku - ZORUNLU
    
    Excel formatÄ±:
    - shift: Vardiya adÄ± (V1, V2, ...)
    - start: BaÅŸlangÄ±Ã§ saati ('07:00')
    - end: BitiÅŸ saati ('16:00')
    - company: (Opsiyonel) A21 veya B21
    
    Ã–rnek:
    shift  | start | end   | company
    V1     | 07:00 | 16:00 | A21
    V2     | 08:00 | 17:00 | A21
    V2     | 08:00 | 17:00 | B21  â† AynÄ± vardiya, farklÄ± firma
    """
    df = pd.read_excel(excel_path)
    
    # Gerekli kolonlar
    required = ['shift', 'start', 'end']
    missing = [col for col in required if col not in df.columns]
    if missing:
        raise ValueError(f"âŒ Eksik kolonlar: {missing}")
    
    shifts = []
    for _, row in df.iterrows():
        shift_dict = {
            'name': str(row['shift']),
            'start': str(row['start']) if not hasattr(row['start'], 'strftime') else row['start'].strftime('%H:%M'),
            'end': str(row['end']) if not hasattr(row['end'], 'strftime') else row['end'].strftime('%H:%M')
        }
        
        # Opsiyonel: company kolonu
        if 'company' in df.columns:
            shift_dict['company'] = str(row['company'])
        
        shifts.append(shift_dict)
    
    print(f"âœ… {len(shifts)} vardiya yÃ¼klendi")
    return shifts


# ============================================================================
# BÃ–LÃœM 1: INTERVAL BAZLI AGENT Ä°HTÄ°YACI (ERLANG C)
# ============================================================================

def erlang_c(agents, traffic):
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_asa(agents, traffic, aht):
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa


def find_agents_for_target(calls, interval_min, aht, target_asa):
    if calls == 0:
        return 0
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    return max_agents


def calculate_interval_requirements(df):
    """Her interval iÃ§in agent ihtiyacÄ±nÄ± hesapla"""
    results = []
    
    for idx, row in df.iterrows():
        date = row['date']
        time = row['time']
        
        # Time object ise string'e Ã§evir
        if hasattr(time, 'strftime'):
            time = time.strftime('%H:%M')
        elif not isinstance(time, str):
            time = str(time)
        
        calls_a = row['queue_a']
        calls_b = row['queue_b']
        
        # A iÃ§in
        agents_a_raw = find_agents_for_target(
            calls_a, CONFIG['interval_minutes'], 
            CONFIG['aht'], CONFIG['target_asa']
        )
        agents_a_final = math.ceil(agents_a_raw / (1 - CONFIG['shrinkage']))
        
        # B iÃ§in
        agents_b_raw = find_agents_for_target(
            calls_b, CONFIG['interval_minutes'],
            CONFIG['aht'], CONFIG['target_asa']
        )
        agents_b_final = math.ceil(agents_b_raw / (1 - CONFIG['shrinkage']))
        
        results.append({
            'date': date,
            'time': time,
            'calls_a': calls_a,
            'calls_b': calls_b,
            'agents_a': agents_a_final,
            'agents_b': agents_b_final,
            'total_agents': agents_a_final + agents_b_final
        })
    
    return pd.DataFrame(results)


# ============================================================================
# BÃ–LÃœM 2: VARDÄ°YALARA SAAT BAZLI DAÄITIM (YENÄ°)
# ============================================================================

def time_to_minutes(time_str):
    if hasattr(time_str, 'strftime'):
        time_str = time_str.strftime('%H:%M')
    h, m = map(int, str(time_str).split(':'))
    return h * 60 + m


def is_time_in_shift(time_str, shift_start, shift_end):
    time_min = time_to_minutes(time_str)
    start_min = time_to_minutes(shift_start)
    end_min = time_to_minutes(shift_end)
    
    if end_min <= start_min:  # Gece vardiyasÄ±
        return time_min >= start_min or time_min < end_min
    else:
        return start_min <= time_min < end_min


# ============================================================================
# BÃ–LÃœM 2: VARDÄ°YALARA AKILLI DAÄITIM (SADECE PEAK)
# ============================================================================

# Peak saat tanÄ±mlarÄ±
PEAK_HOURS = {
    'start': 9,   # 09:00
    'end': 18     # 18:00
}


def is_peak_hour(time_str):
    """Bu saat peak saati mi?"""
    hour = int(time_str.split(':')[0])
    return PEAK_HOURS['start'] <= hour < PEAK_HOURS['end']


def is_peak_shift(shift):
    """Bu vardiya peak saatlerde mi baÅŸlÄ±yor?"""
    shift_start_hour = int(shift['start'].split(':')[0])
    return PEAK_HOURS['start'] <= shift_start_hour < PEAK_HOURS['end']


def distribute_by_peak_priority(interval_df, shifts):
    """
    PEAK Ã–NCELÄ°KLÄ° DAÄITIM
    
    MantÄ±k:
    - Peak saatte: Peak vardiyalara %50 daha fazla aÄŸÄ±rlÄ±k
    - Peak dÄ±ÅŸÄ± saatte: TÃ¼m vardiyalara eÅŸit
    - GerektiÄŸi kadar agent, sÄ±fÄ±r olanlar kaydedilmez
    """
    results = []
    
    for idx, row in interval_df.iterrows():
        date = row['date']
        time = row['time']
        total_needed = row['total_agents']
        
        if total_needed == 0:
            continue
        
        is_peak = is_peak_hour(time)
        
        # Bu saatte Ã§alÄ±ÅŸan vardiyalar
        working_shifts = []
        for shift in shifts:
            if is_time_in_shift(time, shift['start'], shift['end']):
                is_peak_shift_flag = is_peak_shift(shift)
                
                # AÄŸÄ±rlÄ±k: Peak saatte + Peak vardiya = 1.5, diÄŸerleri 1.0
                if is_peak and is_peak_shift_flag:
                    weight = 1.5
                else:
                    weight = 1.0
                
                working_shifts.append({
                    'name': shift['name'],
                    'weight': weight
                })
        
        if len(working_shifts) == 0:
            continue
        
        # AÄŸÄ±rlÄ±klÄ± daÄŸÄ±t
        total_weight = sum(ws['weight'] for ws in working_shifts)
        
        distribution = {}
        for ws in working_shifts:
            ratio = ws['weight'] / total_weight
            agents = total_needed * ratio
            distribution[ws['name']] = agents
        
        # Tam sayÄ±ya yuvarla
        current_total = sum(math.floor(v) for v in distribution.values())
        needed_diff = total_needed - current_total
        
        if needed_diff > 0:
            # En yÃ¼ksek ondalÄ±k kÄ±sma sahip olanlara 1'er ekle
            decimals = {k: v - math.floor(v) for k, v in distribution.items()}
            sorted_shifts = sorted(decimals.items(), key=lambda x: x[1], reverse=True)
            
            for i in range(needed_diff):
                shift_name = sorted_shifts[i % len(sorted_shifts)][0]
                distribution[shift_name] += 1
        
        # SonuÃ§larÄ± kaydet (sadece agent > 0 olanlar)
        for shift_name, agents in distribution.items():
            final_agents = math.floor(agents)
            if final_agents > 0:
                results.append({
                    'date': date,
                    'time': time,
                    'shift': shift_name,
                    'agents_needed': final_agents,
                    'is_peak': is_peak
                })
    
    return pd.DataFrame(results)


def aggregate_shifts(distribution_df, shifts):
    """Her vardiya iÃ§in MAX agent sayÄ±sÄ±"""
    shift_results = []
    
    for date in sorted(distribution_df['date'].unique()):
        date_data = distribution_df[distribution_df['date'] == date]
        
        for shift in shifts:
            shift_data = date_data[date_data['shift'] == shift['name']]
            
            if len(shift_data) > 0:
                max_agents = math.ceil(shift_data['agents_needed'].max())
            else:
                max_agents = 0
            
            if max_agents > 0:
                shift_results.append({
                    'date': date,
                    'shift': shift['name'],
                    'start': shift['start'],
                    'end': shift['end'],
                    'agents': max_agents
                })
    
    return pd.DataFrame(shift_results)


def verify_coverage(interval_df, vardiya_df, shifts):
    """DoÄŸrulama"""
    verify_results = []
    
    for idx, row in interval_df.iterrows():
        date = row['date']
        time = row['time']
        needed = row['total_agents']
        
        if needed == 0:
            continue
        
        date_shifts = vardiya_df[vardiya_df['date'] == date]
        
        total_available = 0
        for _, shift_row in date_shifts.iterrows():
            shift_info = next((s for s in shifts if s['name'] == shift_row['shift']), None)
            if shift_info and is_time_in_shift(time, shift_info['start'], shift_info['end']):
                total_available += shift_row['agents']
        
        verify_results.append({
            'date': date,
            'time': time,
            'needed': needed,
            'available': total_available,
            'sufficient': total_available >= needed,
            'diff': total_available - needed
        })
    
    return pd.DataFrame(verify_results)


# ============================================================================
# ANA FONKSÄ°YON
# ============================================================================

def calculate_complete_planning(df, shift_excel):
    """
    Komple kapasite planlamasÄ±
    
    Parameters:
    - df: Ã‡aÄŸrÄ± tahmini (date, time, queue_a, queue_b)
    - shift_excel: Vardiya Excel dosyasÄ± yolu (ZORUNLU)
    """
    
    print("=" * 70)
    print("KOMPLE KAPASÄ°TE PLANLAMA - V2")
    print("=" * 70)
    
    # VardiyalarÄ± yÃ¼kle
    print(f"\nğŸ“‚ Vardiyalar yÃ¼kleniyor: {shift_excel}")
    shifts = load_shifts_from_excel(shift_excel)
    
    # BÃ–LÃœM 1: Interval bazlÄ± ihtiyaÃ§
    print("\nâš™ï¸ BÃ–LÃœM 1: Interval bazlÄ± agent ihtiyacÄ± hesaplanÄ±yor...")
    interval_df = calculate_interval_requirements(df)
    print(f"âœ… {len(interval_df)} interval hesaplandÄ±")
    print(f"   Peak: {interval_df['total_agents'].max()} agent")
    
    # BÃ–LÃœM 2: Vardiyalara daÄŸÄ±t (PEAK Ã–NCELÄ°KLÄ°)
    print("\nâš™ï¸ BÃ–LÃœM 2: Vardiyalara PEAK Ã–NCELÄ°KLÄ° daÄŸÄ±tÄ±m yapÄ±lÄ±yor...")
    print(f"   Peak saatler: {PEAK_HOURS['start']}:00 - {PEAK_HOURS['end']}:00")
    distribution_df = distribute_by_peak_priority(interval_df, shifts)
    
    print("\nâš™ï¸ BÃ–LÃœM 3: Vardiya bazlÄ± toplama yapÄ±lÄ±yor...")
    vardiya_df = aggregate_shifts(distribution_df, shifts)
    print(f"âœ… {len(vardiya_df)} vardiya-gÃ¼n kombinasyonu")
    
    # BÃ–LÃœM 3: DoÄŸrulama
    print("\nâš™ï¸ BÃ–LÃœM 4: DoÄŸrulama yapÄ±lÄ±yor...")
    verify_df = verify_coverage(interval_df, vardiya_df, shifts)
    
    sufficient_count = verify_df['sufficient'].sum()
    total_count = len(verify_df)
    
    print(f"âœ… {sufficient_count} / {total_count} interval yeterli")
    
    insufficient = verify_df[~verify_df['sufficient']]
    if len(insufficient) > 0:
        print(f"âš ï¸ {len(insufficient)} interval YETERSÄ°Z!")
        print("\nÄ°lk 5 yetersiz interval:")
        print(insufficient[['date', 'time', 'needed', 'available', 'diff']].head(5))
    
    print("\n" + "=" * 70)
    print("âœ… TAMAMLANDI!")
    print("=" * 70)
    
    return interval_df, vardiya_df, verify_df


# ============================================================================
# KULLANIM
# ============================================================================

# ============================================================================
# KULLANIM ve TEST
# ============================================================================

def load_call_forecast_from_sql(connection_string, query=None):
    """
    SQL'den Ã§aÄŸrÄ± tahmini oku
    
    Parameters:
    - connection_string: SQL baÄŸlantÄ± string'i
    - query: SQL sorgusu (opsiyonel, varsayÄ±lan sorgu var)
    
    Ã–rnek connection_string:
    - "mssql+pyodbc://user:pass@server/database?driver=ODBC+Driver+17+for+SQL+Server"
    - "postgresql://user:pass@localhost/database"
    """
    from sqlalchemy import create_engine
    
    if query is None:
        query = """
        SELECT 
            date,
            time,
            queue_a,
            queue_b
        FROM call_forecast
        WHERE date >= DATEADD(day, 0, GETDATE())
        ORDER BY date, time
        """
    
    engine = create_engine(connection_string)
    df = pd.read_sql(query, engine)
    
    print(f"âœ… SQL'den {len(df)} satÄ±r veri okundu")
    return df


def create_sample_data():
    """Ã–rnek test verisi oluÅŸtur"""
    dates = pd.date_range('2025-01-15', '2025-01-16', freq='D')
    times = pd.date_range('00:00', '23:45', freq='15min').strftime('%H:%M')
    
    rows = []
    for date in dates:
        for i, time in enumerate(times):
            # GÃ¼n iÃ§i pattern
            hour = int(time.split(':')[0])
            
            if 7 <= hour < 12:  # Sabah
                calls_a = 30 + (hour - 7) * 5
                calls_b = 15 + (hour - 7) * 3
            elif 12 <= hour < 18:  # Ã–ÄŸle-AkÅŸam (PEAK)
                calls_a = 50 + (i % 4) * 5
                calls_b = 25 + (i % 4) * 3
            elif 18 <= hour < 24:  # AkÅŸam
                calls_a = 40 - (hour - 18) * 3
                calls_b = 20 - (hour - 18) * 2
            else:  # Gece
                calls_a = 10
                calls_b = 5
            
            rows.append({
                'date': date.strftime('%Y-%m-%d'),
                'time': time,
                'queue_a': calls_a,
                'queue_b': calls_b
            })
    
    return pd.DataFrame(rows)


if __name__ == '__main__':
    
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  KOMPLE KAPASÄ°TE PLANLAMA - V2                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

KULLANIM:

# 1. Vardiya Excel'i hazÄ±rla (vardiyalar.xlsx)
#    shift | start | end   | company
#    V1    | 07:00 | 16:00 | A21
#    V2    | 08:00 | 17:00 | A21

# 2. SQL'den Ã§aÄŸrÄ± tahmini oku
df = load_call_forecast_from_sql(connection_string)

# VEYA Excel'den oku
df = pd.read_excel('cagri_tahminleri.xlsx')

# 3. Hesapla
interval_df, vardiya_df, verify_df = calculate_complete_planning(
    df, 
    shift_excel='vardiyalar.xlsx'
)

# 4. Kaydet
vardiya_df.to_excel('vardiya_plani.xlsx', index=False)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
    
    print("\n" + "=" * 70)
    print("Ã–RNEK VERÄ° Ä°LE TEST")
    print("=" * 70)
    
    # Ã–rnek veri oluÅŸtur
    print("\nğŸ“Š Ã–rnek 2 gÃ¼nlÃ¼k veri oluÅŸturuluyor...")
    df = create_sample_data()
    print(f"âœ… {len(df)} satÄ±r veri hazÄ±r")
    
    # Ã–rnek vardiya Excel'i oluÅŸtur
    print("\nğŸ“‚ Ã–rnek vardiya Excel'i oluÅŸturuluyor...")
    sample_shifts = pd.DataFrame([
        {'shift': 'V1', 'start': '07:00', 'end': '16:00', 'company': 'A21'},
        {'shift': 'V2', 'start': '08:00', 'end': '17:00', 'company': 'A21'},
        {'shift': 'V3', 'start': '09:00', 'end': '18:00', 'company': 'A21'},
        {'shift': 'V10', 'start': '08:00', 'end': '17:30', 'company': 'B21'},
        {'shift': 'V11', 'start': '09:00', 'end': '18:30', 'company': 'B21'},
    ])
    sample_shifts.to_excel('_test_vardiyalar.xlsx', index=False)
    print("âœ… _test_vardiyalar.xlsx oluÅŸturuldu")
    
    # Hesapla
    print("\n" + "=" * 70)
    interval_df, vardiya_df, verify_df = calculate_complete_planning(
        df, 
        shift_excel='_test_vardiyalar.xlsx'
    )
    
    # SonuÃ§larÄ± gÃ¶ster
    print("\n" + "=" * 70)
    print("ğŸ“Š SONUÃ‡LAR")
    print("=" * 70)
    
    print("\n1ï¸âƒ£ VARDÄ°YA PLANI:")
    print(vardiya_df.to_string(index=False))
    
    print("\n2ï¸âƒ£ DOÄRULAMA (Ä°lk 10):")
    print(verify_df[['date', 'time', 'needed', 'available', 'sufficient', 'diff']].head(10).to_string(index=False))
    
    # Ã–zet
    print("\n" + "=" * 70)
    print("ğŸ“ˆ Ã–ZET")
    print("=" * 70)
    print(f"Peak agent ihtiyacÄ±: {interval_df['total_agents'].max()}")
    print(f"Toplam vardiya-gÃ¼n: {len(vardiya_df)}")
    print(f"Yeterli interval: {verify_df['sufficient'].sum()} / {len(verify_df)}")
    
    insufficient = verify_df[~verify_df['sufficient']]
    if len(insufficient) > 0:
        print(f"\nâš ï¸ YETERSÄ°Z: {len(insufficient)} interval")
    else:
        print("\nâœ… TÃœM Ä°NTERVALLER YETERLÄ°!")
