"""
ADIM 2: B AgentlarÄ± A'ya YardÄ±m Eder
Hafta iÃ§i mantÄ±ÄŸÄ± - B agentlarÄ± hem A hem B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar
"""
import pandas as pd
import math

def erlang_c(agents, traffic):
    if agents <= traffic or agents == 0:
        return 1.0
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)

def calculate_asa(agents, traffic, aht):
    if agents <= traffic:
        return 999
    ec = erlang_c(agents, traffic)
    asa = (ec * (aht / 60)) / (agents - traffic) * 60
    return asa

def find_agents_for_target(calls, interval_min, aht, target_asa):
    if calls == 0:
        return 0
    traffic = (calls * (aht / 60)) / interval_min
    if traffic == 0:
        return 0
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 2) + 5
    for agents in range(min_agents, max_agents + 1):
        asa = calculate_asa(agents, traffic, aht)
        if asa <= target_asa:
            return agents
    return max_agents


def calculate_with_support(calls_a, calls_b, interval_min=30, aht=180, 
                           target_asa=30, shrinkage=0.10):
    """
    B agentlarÄ± A'ya yardÄ±m eder
    
    MantÄ±k:
    1. B kuyruÄŸu iÃ§in B agentlarÄ± hesapla
    2. Toplam Ã§aÄŸrÄ± (A+B) iÃ§in gereken B agentÄ± hesapla
    3. EÄŸer toplam iÃ§in gereken â‰¤ B iÃ§in gereken:
       â†’ B agentlarÄ± hepsini karÅŸÄ±lar, A agentÄ± gerekmez
    4. DeÄŸilse:
       â†’ B agentlarÄ± B'yi karÅŸÄ±lar, A iÃ§in ekstra A agentÄ± gerek
    
    B agentlarÄ±:
    - B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar (Ã¶ncelik)
    - BoÅŸ kalÄ±rsa A'ya yardÄ±m eder
    
    A agentlarÄ±:
    - Sadece A Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar
    """
    
    # 1. B kuyruÄŸu iÃ§in gereken B agentlarÄ±
    traffic_b = (calls_b * (aht/60)) / interval_min if calls_b > 0 else 0
    agents_for_b = find_agents_for_target(calls_b, interval_min, aht, target_asa)
    
    # 2. Toplam Ã§aÄŸrÄ± (A+B) iÃ§in gereken agent
    total_calls = calls_a + calls_b
    traffic_total = (total_calls * (aht/60)) / interval_min if total_calls > 0 else 0
    agents_for_total = find_agents_for_target(total_calls, interval_min, aht, target_asa)
    
    # 3. Karar: B agentlarÄ± yeterli mi?
    if agents_for_total <= agents_for_b:
        # B agentlarÄ± hem A hem B'yi karÅŸÄ±lar
        agents_b_needed = agents_for_total
        agents_a_needed = 0
    else:
        # B agentlarÄ± B'yi karÅŸÄ±lar, A iÃ§in ekstra gerek
        agents_b_needed = agents_for_b
        agents_a_needed = find_agents_for_target(calls_a, interval_min, aht, target_asa)
    
    # Shrinkage ekle
    final_a = math.ceil(agents_a_needed / (1 - shrinkage))
    final_b = math.ceil(agents_b_needed / (1 - shrinkage))
    
    return {
        'calls_a': calls_a,
        'calls_b': calls_b,
        'traffic_b': round(traffic_b, 2),
        'traffic_total': round(traffic_total, 2),
        'agents_a': final_a,
        'agents_b': final_b,
        'total_agents': final_a + final_b,
        'b_helps_a': agents_a_needed == 0  # B yardÄ±m etti mi?
    }


# TEST: BAÄIMSIZ vs YARDIMLAÅMALI KARÅILAÅTIRMA
if __name__ == '__main__':
    print("=" * 60)
    print("ADIM 2: B AGENTLARI A'YA YARDIM EDER")
    print("=" * 60)
    
    # Test senaryosu
    calls_a = 50
    calls_b = 30
    
    print(f"\nğŸ“‹ Senaryo:")
    print(f"  A Ã‡aÄŸrÄ±: {calls_a}")
    print(f"  B Ã‡aÄŸrÄ±: {calls_b}")
    print(f"  Toplam: {calls_a + calls_b}\n")
    
    # YÃ–NTEM 1: BaÄŸÄ±msÄ±z (ADIM 1)
    print("=" * 60)
    print("YÃ–NTEM 1: BAÄIMSIZ (YardÄ±mlaÅŸma Yok)")
    print("=" * 60)
    
    traffic_a = (calls_a * 3) / 30
    traffic_b = (calls_b * 3) / 30
    agents_a_ind = find_agents_for_target(calls_a, 30, 180, 30)
    agents_b_ind = find_agents_for_target(calls_b, 30, 180, 30)
    agents_a_final_ind = math.ceil(agents_a_ind / 0.9)
    agents_b_final_ind = math.ceil(agents_b_ind / 0.9)
    total_ind = agents_a_final_ind + agents_b_final_ind
    
    print(f"A: {calls_a} Ã§aÄŸrÄ± (Traffic: {traffic_a:.1f}) â†’ {agents_a_final_ind} agent")
    print(f"B: {calls_b} Ã§aÄŸrÄ± (Traffic: {traffic_b:.1f}) â†’ {agents_b_final_ind} agent")
    print(f"TOPLAM: {total_ind} agent")
    
    # YÃ–NTEM 2: YardÄ±mlaÅŸmalÄ± (ADIM 2)
    print("\n" + "=" * 60)
    print("YÃ–NTEM 2: YARDIMLAÅMALI (B AgentlarÄ± A'ya YardÄ±m)")
    print("=" * 60)
    
    result = calculate_with_support(calls_a, calls_b)
    
    print(f"A: {result['calls_a']} Ã§aÄŸrÄ± â†’ {result['agents_a']} agent")
    print(f"B: {result['calls_b']} Ã§aÄŸrÄ± â†’ {result['agents_b']} agent")
    print(f"TOPLAM: {result['total_agents']} agent")
    print(f"B yardÄ±m etti mi? {'âœ… Evet' if result['b_helps_a'] else 'âŒ HayÄ±r'}")
    
    # KarÅŸÄ±laÅŸtÄ±rma
    print("\n" + "=" * 60)
    print("ğŸ’° TASARRUF ANALÄ°ZÄ°")
    print("=" * 60)
    
    saving = total_ind - result['total_agents']
    saving_pct = (saving / total_ind * 100) if total_ind > 0 else 0
    
    print(f"BaÄŸÄ±msÄ±z: {total_ind} agent")
    print(f"YardÄ±mlaÅŸmalÄ±: {result['total_agents']} agent")
    print(f"Tasarruf: {saving} agent ({saving_pct:.1f}%)")
    
    if saving > 0:
        print(f"\nâœ… {saving} agent daha az gerekiyor!")
    else:
        print(f"\nâš ï¸ Bu senaryoda fark yok")
    
    print("\n" + "=" * 60)
    print("ğŸ’¡ MANTIK:")
    print("=" * 60)
    print("BaÄŸÄ±msÄ±z:")
    print("  A agentlarÄ±: Sadece A")
    print("  B agentlarÄ±: Sadece B")
    print("  â†’ Her kuyruk kendi baÅŸÄ±na\n")
    print("YardÄ±mlaÅŸmalÄ±:")
    print("  A agentlarÄ±: Sadece A")
    print("  B agentlarÄ±: B + boÅŸsa A'ya yardÄ±m")
    print("  â†’ B agentlarÄ± Ã§ift gÃ¶rev!")
