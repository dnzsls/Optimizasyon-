## claudie yorumu gÃ¼zel sakla
import pandas as pd
import numpy as np
import math

# KonfigÃ¼rasyon
CONFIG = {
    'aht': 188,  # saniye
    'target_sl': 0.80,  # %80 servis seviyesi
    'target_asa': 30,  # 30 saniye iÃ§inde yanÄ±t
    'shrinkage': 0.10,  # %10 mola/eÄŸitim/izin
    'interval_minutes': 30
}

# Vardiya tanÄ±mlarÄ±
SHIFTS = [
    {'name': 'V1', 'start': '07:00', 'end': '16:00', 'duration': 9},
    {'name': 'V2', 'start': '08:00', 'end': '17:00', 'duration': 9},
    {'name': 'V3', 'start': '09:00', 'end': '18:00', 'duration': 9},
    {'name': 'V4', 'start': '10:00', 'end': '19:00', 'duration': 9},
    {'name': 'V5', 'start': '15:00', 'end': '24:00', 'duration': 9},
    {'name': 'V6', 'start': '17:00', 'end': '01:00', 'duration': 8, 'overnight': True},
    {'name': 'V7', 'start': '18:00', 'end': '02:00', 'duration': 8, 'overnight': True},
    {'name': 'V8', 'start': '19:00', 'end': '03:00', 'duration': 8, 'overnight': True},
    {'name': 'V9', 'start': '00:00', 'end': '08:00', 'duration': 8},
    {'name': 'V10', 'start': '08:00', 'end': '17:30', 'duration': 9.5},
    {'name': 'V11', 'start': '09:00', 'end': '18:30', 'duration': 9.5},
    {'name': 'V12', 'start': '10:00', 'end': '19:30', 'duration': 9.5},
    {'name': 'V13', 'start': '11:00', 'end': '20:30', 'duration': 9.5},
    {'name': 'V14', 'start': '12:00', 'end': '21:30', 'duration': 9.5},
    {'name': 'V15', 'start': '13:00', 'end': '22:30', 'duration': 9.5},
    {'name': 'V16', 'start': '14:00', 'end': '23:30', 'duration': 9.5},
    {'name': 'V17', 'start': '15:00', 'end': '00:30', 'duration': 9.5, 'overnight': True},
    {'name': 'V18', 'start': '17:00', 'end': '01:30', 'duration': 8.5, 'overnight': True},
    {'name': 'V19', 'start': '18:00', 'end': '02:30', 'duration': 8.5, 'overnight': True}
]


def erlang_c(agents, traffic):
    """Erlang C formÃ¼lÃ¼ ile kuyruk olasÄ±lÄ±ÄŸÄ± hesapla"""
    if agents <= traffic or agents == 0:
        return 1.0
    
    # Erlang B hesapla
    erlang_b = traffic / agents
    for i in range(2, int(agents) + 1):
        erlang_b = (traffic * erlang_b) / (i + traffic * erlang_b)
    
    # Erlang C hesapla
    erlang_c_val = erlang_b / (1 - (traffic / agents) * (1 - erlang_b))
    return min(erlang_c_val, 1.0)


def calculate_agents(calls, interval_min, aht, target_asa):
    """Gerekli agent sayÄ±sÄ±nÄ± hesapla"""
    if calls == 0:
        return 0
    
    # Traffic hesapla (Erlang)
    traffic = (calls * (aht / 60)) / interval_min
    
    if traffic == 0:
        return 0
    
    # Binary search ile optimal agent sayÄ±sÄ±nÄ± bul
    min_agents = math.ceil(traffic)
    max_agents = math.ceil(traffic * 3) + 5
    
    for agents in range(min_agents, max_agents + 1):
        ec = erlang_c(agents, traffic)
        
        # Average Speed to Answer (ASA) hesapla
        if agents > traffic:
            asa = (ec * (aht / 60)) / (agents - traffic) * 60  # saniye
        else:
            asa = 999
        
        if asa <= target_asa:
            return agents
    
    return max_agents


def generate_sample_data(is_weekend=False):
    """Ã–rnek Ã§aÄŸrÄ± verisi oluÅŸtur - 24 saat, 30 dakikalÄ±k intervallerle"""
    multiplier = 0.6 if is_weekend else 1.0
    
    data = []
    for hour in range(24):
        for minute in [0, 30]:
            time = f"{hour:02d}:{minute:02d}"
            
            # GÃ¼n iÃ§indeki yoÄŸunluÄŸa gÃ¶re Ã§aÄŸrÄ± sayÄ±sÄ±
            if 8 <= hour <= 16:  # Peak saatler
                base_a = 80 + (hour - 8) * 5
                base_b = 30 + (hour - 8) * 2
            elif 17 <= hour <= 22:  # AkÅŸam
                base_a = 70 - (hour - 17) * 10
                base_b = 25 - (hour - 17) * 4
            else:  # Gece
                base_a = 5
                base_b = 2
            
            data.append({
                'time': time,
                'queue_a': round(base_a * multiplier),
                'queue_b': round(base_b * multiplier)
            })
    
    return pd.DataFrame(data)


def calculate_weekday_staffing(df):
    """
    Hafta iÃ§i agent ihtiyacÄ±nÄ± hesapla
    
    MantÄ±k:
    - B kuyruÄŸuna gelen Ã§aÄŸrÄ±larÄ± SADECE B agentlarÄ± karÅŸÄ±lar
    - A kuyruÄŸuna gelen Ã§aÄŸrÄ±larÄ± hem A hem B agentlarÄ± karÅŸÄ±layabilir
    - Toplam A Ã§aÄŸrÄ±sÄ± iÃ§in toplam agent (A+B) hesapla
    - B Ã§aÄŸrÄ±sÄ± iÃ§in sadece B agent hesapla
    - B agent sayÄ±sÄ± >= B iÃ§in gereken
    - A agent sayÄ±sÄ± = Toplam - B agent
    """
    results = []
    
    for idx, row in df.iterrows():
        # B kuyruÄŸu iÃ§in gereken agent (sadece B agentlarÄ± karÅŸÄ±lar)
        agents_for_b = calculate_agents(
            row['queue_b'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )
        
        # A kuyruÄŸu iÃ§in A+B agentlarÄ± birlikte Ã§alÄ±ÅŸÄ±r
        # Toplam ihtiyaÃ§ = A Ã§aÄŸrÄ±larÄ± iÃ§in gereken agent
        agents_for_a = calculate_agents(
            row['queue_a'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )
        
        # B agentlarÄ± hem B hem A'ya bakÄ±yor, A agentlarÄ± sadece A'ya bakÄ±yor
        # Toplam agent = A iÃ§in gereken + B iÃ§in gereken
        # Ama B agentlarÄ± zaten A'ya da yardÄ±m ediyor, o yÃ¼zden:
        # - B agent: B Ã§aÄŸrÄ±larÄ± iÃ§in minimum gerekli
        # - A agent: A Ã§aÄŸrÄ±larÄ± iÃ§in gereken (B'nin yardÄ±mÄ± dahil hesaplanÄ±r)
        
        agents_b = agents_for_b
        agents_a = agents_for_a
        
        # Shrinkage ekle (mola, eÄŸitim, izin iÃ§in %10 ekstra)
        final_agents_a = math.ceil(agents_a / (1 - CONFIG['shrinkage']))
        final_agents_b = math.ceil(agents_b / (1 - CONFIG['shrinkage']))
        
        results.append({
            'time': row['time'],
            'queue_a_calls': row['queue_a'],
            'queue_b_calls': row['queue_b'],
            'agents_a': final_agents_a,
            'agents_b': final_agents_b,
            'total_agents': final_agents_a + final_agents_b
        })
    
    return pd.DataFrame(results)


def calculate_weekend_staffing(df):
    """
    Hafta sonu agent ihtiyacÄ±nÄ± hesapla
    
    MantÄ±k:
    - Kuyruklar arasÄ± yardÄ±m YOK
    - B kuyruÄŸu = B agentlarÄ±
    - A kuyruÄŸu = A agentlarÄ±
    - Her kuyruk baÄŸÄ±msÄ±z
    """
    results = []
    
    for idx, row in df.iterrows():
        # A kuyruÄŸu - sadece A agentlarÄ±
        agents_a = calculate_agents(
            row['queue_a'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )
        
        # B kuyruÄŸu - sadece B agentlarÄ±
        agents_b = calculate_agents(
            row['queue_b'],
            CONFIG['interval_minutes'],
            CONFIG['aht'],
            CONFIG['target_asa']
        )
        
        # Shrinkage ekle
        final_agents_a = math.ceil(agents_a / (1 - CONFIG['shrinkage']))
        final_agents_b = math.ceil(agents_b / (1 - CONFIG['shrinkage']))
        
        results.append({
            'time': row['time'],
            'queue_a_calls': row['queue_a'],
            'queue_b_calls': row['queue_b'],
            'agents_a': final_agents_a,
            'agents_b': final_agents_b,
            'total_agents': final_agents_a + final_agents_b
        })
    
    return pd.DataFrame(results)


def is_time_in_shift(time_str, shift):
    """Zaman diliminin vardiya iÃ§inde olup olmadÄ±ÄŸÄ±nÄ± kontrol et"""
    h, m = map(int, time_str.split(':'))
    time_minutes = h * 60 + m
    
    start_h, start_m = map(int, shift['start'].split(':'))
    start_minutes = start_h * 60 + start_m
    
    end_h, end_m = map(int, shift['end'].split(':'))
    end_minutes = end_h * 60 + end_m
    
    # Gece vardiyalarÄ± iÃ§in (ertesi gÃ¼ne geÃ§en)
    if shift.get('overnight', False) and end_minutes <= start_minutes:
        end_minutes += 24 * 60
        if time_minutes < start_minutes:
            time_minutes += 24 * 60
    
    return start_minutes <= time_minutes < end_minutes


def calculate_shift_requirements(weekday_df, weekend_df):
    """Vardiya bazlÄ± agent ihtiyacÄ±nÄ± hesapla"""
    shift_results = []
    
    for shift in SHIFTS:
        # Hafta iÃ§i iÃ§in bu vardiyada max ihtiyaÃ§
        weekday_intervals = weekday_df[
            weekday_df['time'].apply(lambda x: is_time_in_shift(x, shift))
        ]
        weekday_max = weekday_intervals['total_agents'].max() if len(weekday_intervals) > 0 else 0
        
        # Hafta sonu iÃ§in bu vardiyada max ihtiyaÃ§
        weekend_intervals = weekend_df[
            weekend_df['time'].apply(lambda x: is_time_in_shift(x, shift))
        ]
        weekend_max = weekend_intervals['total_agents'].max() if len(weekend_intervals) > 0 else 0
        
        shift_results.append({
            'shift_name': shift['name'],
            'start_time': shift['start'],
            'end_time': shift['end'],
            'duration_hours': shift['duration'],
            'weekday_agents_needed': int(weekday_max),
            'weekend_agents_needed': int(weekend_max)
        })
    
    return pd.DataFrame(shift_results)


def calculate_with_custom_data(df_weekday, df_weekend=None):
    """
    Kendi Ã§aÄŸrÄ± verinle hesaplama yap
    
    Parameters:
    -----------
    df_weekday : DataFrame
        Columns: 'time', 'queue_a', 'queue_b'
        Hafta iÃ§i Ã§aÄŸrÄ± tahminleri
    
    df_weekend : DataFrame, optional
        Columns: 'time', 'queue_a', 'queue_b'
        Hafta sonu Ã§aÄŸrÄ± tahminleri (opsiyonel)
    
    Returns:
    --------
    tuple : (weekday_staffing, weekend_staffing, shift_analysis)
    """
    
    print("\nğŸ“Š Kendi verinle hesaplama yapÄ±lÄ±yor...")
    print(f"Hafta iÃ§i veri: {len(df_weekday)} satÄ±r")
    
    # Hafta iÃ§i hesaplama
    weekday_staffing = calculate_weekday_staffing(df_weekday)
    
    # Hafta sonu hesaplama
    if df_weekend is not None:
        print(f"Hafta sonu veri: {len(df_weekend)} satÄ±r")
        weekend_staffing = calculate_weekend_staffing(df_weekend)
    else:
        print("Hafta sonu veri yok, hafta iÃ§i verinin %60'Ä± kullanÄ±lÄ±yor")
        df_weekend_generated = df_weekday.copy()
        df_weekend_generated['queue_a'] = (df_weekend_generated['queue_a'] * 0.6).round()
        df_weekend_generated['queue_b'] = (df_weekend_generated['queue_b'] * 0.6).round()
        weekend_staffing = calculate_weekend_staffing(df_weekend_generated)
    
    # Vardiya analizi
    shift_analysis = calculate_shift_requirements(weekday_staffing, weekend_staffing)
    
    return weekday_staffing, weekend_staffing, shift_analysis


def main():
    """Ana fonksiyon - tÃ¼m hesaplamalarÄ± yap ve sonuÃ§larÄ± gÃ¶ster"""
    
    print("=" * 80)
    print("Ã‡AÄRI MERKEZÄ° KAPASÄ°TE PLANLAMA ANALÄ°ZÄ°")
    print("=" * 80)
    print(f"\nKonfigÃ¼rasyon:")
    print(f"  - AHT: {CONFIG['aht']} saniye")
    print(f"  - Hedef Servis Seviyesi: {CONFIG['target_sl']*100}%")
    print(f"  - Hedef YanÄ±t SÃ¼resi: {CONFIG['target_asa']} saniye")
    print(f"  - Shrinkage: {CONFIG['shrinkage']*100}%")
    print(f"\nKuyruk MantÄ±ÄŸÄ±:")
    print(f"  - Hafta Ä°Ã§i: B agentlarÄ± B Ã§aÄŸrÄ±larÄ±nÄ± karÅŸÄ±lar + A'ya yardÄ±m eder")
    print(f"  - Hafta Sonu: Kuyruklar baÄŸÄ±msÄ±z, yardÄ±m yok")
    print("\n" + "=" * 80)
    
    # 1. Ã–rnek veri oluÅŸtur
    print("\n[1/4] Ã–rnek Ã§aÄŸrÄ± verisi oluÅŸturuluyor...")
    weekday_calls = generate_sample_data(is_weekend=False)
    weekend_calls = generate_sample_data(is_weekend=True)
    
    # 2. Hafta iÃ§i agent hesapla
    print("[2/4] Hafta iÃ§i agent ihtiyacÄ± hesaplanÄ±yor...")
    weekday_staffing = calculate_weekday_staffing(weekday_calls)
    
    # 3. Hafta sonu agent hesapla
    print("[3/4] Hafta sonu agent ihtiyacÄ± hesaplanÄ±yor...")
    weekend_staffing = calculate_weekend_staffing(weekend_calls)
    
    # 4. Vardiya analizi
    print("[4/4] Vardiya bazlÄ± analiz yapÄ±lÄ±yor...")
    shift_analysis = calculate_shift_requirements(weekday_staffing, weekend_staffing)
    
    # Ã–zet istatistikler
    print("\n" + "=" * 80)
    print("ğŸ“Š HAFTA Ä°Ã‡Ä° Ã–ZET")
    print("-" * 80)
    print(f"Toplam GÃ¼nlÃ¼k Ã‡aÄŸrÄ±: {weekday_staffing['queue_a_calls'].sum() + weekday_staffing['queue_b_calls'].sum()}")
    print(f"  - A KuyruÄŸu: {weekday_staffing['queue_a_calls'].sum()}")
    print(f"  - B KuyruÄŸu: {weekday_staffing['queue_b_calls'].sum()}")
    print(f"Peak Agent Ä°htiyacÄ±: {weekday_staffing['total_agents'].max()}")
    print(f"  - A AgentlarÄ±: {weekday_staffing['agents_a'].max()}")
    print(f"  - B AgentlarÄ±: {weekday_staffing['agents_b'].max()}")
    print(f"Ortalama Agent Ä°htiyacÄ±: {weekday_staffing['total_agents'].mean():.1f}")
    print(f"Peak Saati: {weekday_staffing.loc[weekday_staffing['total_agents'].idxmax(), 'time']}")
    
    print("\nğŸ“Š HAFTA SONU Ã–ZET")
    print("-" * 80)
    print(f"Toplam GÃ¼nlÃ¼k Ã‡aÄŸrÄ±: {weekend_staffing['queue_a_calls'].sum() + weekend_staffing['queue_b_calls'].sum()}")
    print(f"  - A KuyruÄŸu: {weekend_staffing['queue_a_calls'].sum()}")
    print(f"  - B KuyruÄŸu: {weekend_staffing['queue_b_calls'].sum()}")
    print(f"Peak Agent Ä°htiyacÄ±: {weekend_staffing['total_agents'].max()}")
    print(f"  - A AgentlarÄ±: {weekend_staffing['agents_a'].max()}")
    print(f"  - B AgentlarÄ±: {weekend_staffing['agents_b'].max()}")
    print(f"Ortalama Agent Ä°htiyacÄ±: {weekend_staffing['total_agents'].mean():.1f}")
    print(f"Peak Saati: {weekend_staffing.loc[weekend_staffing['total_agents'].idxmax(), 'time']}")
    
    print("\n" + "=" * 80)
    print("\nğŸ“‹ HAFTA Ä°Ã‡Ä° DETAYLI AGENT Ä°HTÄ°YACI (Ä°lk 20 satÄ±r)")
    print("-" * 80)
    print(weekday_staffing.head(20).to_string(index=False))
    
    print("\n\nğŸ“‹ HAFTA SONU DETAYLI AGENT Ä°HTÄ°YACI (Ä°lk 20 satÄ±r)")
    print("-" * 80)
    print(weekend_staffing.head(20).to_string(index=False))
    
    print("\n\nğŸ“… VARDÄ°YA BAZLI AGENT Ä°HTÄ°YACI")
    print("-" * 80)
    print(shift_analysis.to_string(index=False))
    
    print("\n" + "=" * 80)
    
    # Excel'e kaydet
    try:
        with pd.ExcelWriter('call_center_staffing_plan.xlsx', engine='openpyxl') as writer:
            weekday_staffing.to_excel(writer, sheet_name='Hafta_Ici', index=False)
            weekend_staffing.to_excel(writer, sheet_name='Hafta_Sonu', index=False)
            shift_analysis.to_excel(writer, sheet_name='Vardiya_Plani', index=False)
        print("\nâœ… SonuÃ§lar 'call_center_staffing_plan.xlsx' dosyasÄ±na kaydedildi!")
    except Exception as e:
        print(f"\nâš ï¸  Excel kaydetme hatasÄ±: {e}")
        print("Not: openpyxl kurulu deÄŸilse: pip install openpyxl")
    
    # DataFrame'leri dÃ¶ndÃ¼r
    return weekday_staffing, weekend_staffing, shift_analysis


# Ã‡ALIÅTIR
if __name__ == "__main__":
    weekday_df, weekend_df, shifts_df = main()
    
    # Ek analiz Ã¶rneÄŸi - Peak saatlere odaklan
    print("\n\nğŸ” PEAK SAATLER ANALÄ°ZÄ° (09:00-17:00)")
    print("-" * 80)
    peak_hours = weekday_df[
        (weekday_df['time'] >= '09:00') & 
        (weekday_df['time'] <= '17:00')
    ]
    print(peak_hours.to_string(index=False))
    
    print("\n\nğŸ’¡ KENDÄ° VERÄ°NLE KULLANMAK Ä°Ã‡Ä°N:")
    print("-" * 80)
    print("""
# CSV'den oku
df_calls = pd.read_csv('cagri_tahmin.csv')
# Gerekli kolonlar: time, queue_a, queue_b

# Hesapla
weekday, weekend, shifts = calculate_with_custom_data(df_calls)
print(weekday)
    """)
