"""
ADIM 1: SİMÜLASYON
==================
Dağılımları oluşturur ve yıllık simülasyonu çalıştırır.
Sonuçları CSV olarak kaydeder.
"""

import numpy as np
import pandas as pd
from datetime import datetime
from dateutil.relativedelta import relativedelta
from collections import defaultdict
import pickle
import time

# =============================================================================
# AYARLAR - BUNLARI DEĞİŞTİR
# =============================================================================

# Görev konfigürasyonları
tasks_config = {
    1001: {"task_point": 5, "max_count": 10, "start_date": "2023-01-01"},
    1002: {"task_point": 3, "max_count": 8, "start_date": "2024-01-01"},
    # ... diğer görevleri ekle
}

# Threshold değerleri
thresholds = {
    "T1": {"value": 1000, "reward": 10},
    "T2": {"value": 2500, "reward": 10},
    "T3": {"value": 4000, "reward": 10},
}

# Simülasyon parametreleri
START_CUSTOMERS = 1_000_000
END_CUSTOMERS = 1_500_000
SIMULATION_YEAR = 2026
DECAY = 0.9
RANDOM_SEED = 42

# =============================================================================
# YARDIMCI FONKSİYONLAR
# =============================================================================

def calculate_months_ago(date, max_date):
    """İki tarih arasındaki ay farkını hesaplar."""
    return (max_date.year - date.year) * 12 + (max_date.month - date.month)


def calculate_time_weight(months_ago, decay=0.9):
    """Recency ağırlığını hesaplar."""
    return decay ** months_ago


def normalize_weights(weights):
    """Ağırlıkları normalize eder (toplam = 1)."""
    total = weights.sum()
    if total == 0:
        return np.ones_like(weights) / len(weights)
    return weights / total


# =============================================================================
# DAĞILIM FONKSİYONLARI
# =============================================================================

def build_recency_weighted_empirical_per_customer_task(df, decay=0.9):
    """Her (musteri_id, gorev_id) çifti için recency-weighted dağılım oluşturur."""
    
    print("  Müşteri-görev dağılımları oluşturuluyor...")
    
    df = df.copy()
    df['data_date'] = pd.to_datetime(df['data_date'])
    max_date = df['data_date'].max()
    
    # Ay farkı ve ağırlık hesapla
    df['months_ago'] = df['data_date'].apply(lambda x: calculate_months_ago(x, max_date))
    df['time_weight'] = df['months_ago'].apply(lambda x: calculate_time_weight(x, decay))
    
    recency_dists = {}
    
    grouped = df.groupby(['musteri_id', 'gorev_id'])
    total_groups = len(grouped)
    
    for idx, ((musteri_id, gorev_id), group) in enumerate(grouped):
        value_weights = group.groupby('gorev_orjinal_count')['time_weight'].sum()
        
        values = value_weights.index.values.astype(float)
        weights = value_weights.values
        probs = normalize_weights(weights)
        
        recency_dists[(musteri_id, gorev_id)] = {
            "values": values,
            "probs": probs
        }
        
        # İlerleme göster
        if (idx + 1) % 100000 == 0:
            print(f"    {idx + 1:,} / {total_groups:,} tamamlandı")
    
    print(f"  Toplam {len(recency_dists):,} müşteri-görev dağılımı oluşturuldu.")
    return recency_dists


def build_global_recency_weighted_empirical_per_task(df, decay=0.9):
    """Her gorev_id için global recency-weighted dağılım oluşturur."""
    
    print("  Global görev dağılımları oluşturuluyor...")
    
    df = df.copy()
    df['data_date'] = pd.to_datetime(df['data_date'])
    max_date = df['data_date'].max()
    
    df['months_ago'] = df['data_date'].apply(lambda x: calculate_months_ago(x, max_date))
    df['time_weight'] = df['months_ago'].apply(lambda x: calculate_time_weight(x, decay))
    
    global_dists = {}
    
    grouped = df.groupby('gorev_id')
    
    for gorev_id, group in grouped:
        value_weights = group.groupby('gorev_orjinal_count')['time_weight'].sum()
        
        values = value_weights.index.values.astype(float)
        weights = value_weights.values
        probs = normalize_weights(weights)
        
        global_dists[gorev_id] = {
            "values": values,
            "probs": probs
        }
    
    print(f"  Toplam {len(global_dists)} görev için global dağılım oluşturuldu.")
    return global_dists


# =============================================================================
# SİMÜLASYON FONKSİYONU
# =============================================================================

def generate_monthly_customer_counts(start_customers, end_customers, months=12):
    """Lineer müşteri artışı hesaplar."""
    result = []
    for i in range(months):
        customer_count = int(start_customers + (end_customers - start_customers) * i / (months - 1))
        result.append(customer_count)
    return result


def simulate_year(df, tasks_config, thresholds, start_customers, end_customers, 
                  simulation_year, decay=0.9, random_seed=None):
    """Bir yıllık simülasyon yapar."""
    
    if random_seed is not None:
        np.random.seed(random_seed)
    
    start_time = time.time()
    
    # ADIM 1: Dağılımları oluştur
    print("\n[1/4] Dağılımlar oluşturuluyor...")
    customer_task_dists = build_recency_weighted_empirical_per_customer_task(df, decay)
    global_task_dists = build_global_recency_weighted_empirical_per_task(df, decay)
    
    # Dağılımları kaydet (sonraki adımlar için)
    print("  Dağılımlar kaydediliyor...")
    with open('distributions.pkl', 'wb') as f:
        pickle.dump({
            'customer_task_dists': customer_task_dists,
            'global_task_dists': global_task_dists
        }, f)
    
    # ADIM 2: Müşteri setlerini hazırla
    print("\n[2/4] Müşteri setleri hazırlanıyor...")
    existing_customers = set(df['musteri_id'].unique())
    print(f"  Mevcut müşteri sayısı: {len(existing_customers):,}")
    
    monthly_counts = generate_monthly_customer_counts(start_customers, end_customers)
    
    existing_customer_tasks = defaultdict(set)
    for (cust_id, task_id) in customer_task_dists.keys():
        existing_customer_tasks[cust_id].add(task_id)
    
    all_task_ids = list(tasks_config.keys())
    
    max_existing_id = max(existing_customers) if existing_customers else 0
    new_customer_id_counter = max_existing_id + 1
    
    active_customers = set()
    new_customer_mapping = {}
    
    # ADIM 3: Aylık simülasyon
    print("\n[3/4] Simülasyon başlıyor...")
    monthly_results = []
    
    for month_idx in range(12):
        month_start = time.time()
        month_num = month_idx + 1
        month_end_date = datetime(simulation_year, month_num, 1) + relativedelta(months=1, days=-1)
        target_customer_count = monthly_counts[month_idx]
        
        current_count = len(active_customers)
        new_customers_needed = target_customer_count - current_count
        
        # Müşteri ekleme
        if month_idx == 0:
            if len(existing_customers) >= target_customer_count:
                active_customers = set(np.random.choice(
                    list(existing_customers), 
                    size=target_customer_count, 
                    replace=False
                ))
            else:
                active_customers = existing_customers.copy()
                new_needed = target_customer_count - len(active_customers)
                for _ in range(new_needed):
                    new_customer_mapping[new_customer_id_counter] = month_num
                    active_customers.add(new_customer_id_counter)
                    new_customer_id_counter += 1
        else:
            for _ in range(max(0, new_customers_needed)):
                new_customer_mapping[new_customer_id_counter] = month_num
                active_customers.add(new_customer_id_counter)
                new_customer_id_counter += 1
        
        # Her müşteri için simülasyon
        month_data = []
        customer_count = 0
        
        for customer_id in active_customers:
            customer_monthly_points = 0
            
            for task_id in all_task_ids:
                task_cfg = tasks_config[task_id]
                task_start = pd.to_datetime(task_cfg["start_date"])
                
                if month_end_date < task_start:
                    continue
                
                task_point = task_cfg["task_point"]
                max_count = task_cfg["max_count"]
                
                # Count çek
                if customer_id in existing_customers and (customer_id, task_id) in customer_task_dists:
                    dist = customer_task_dists[(customer_id, task_id)]
                    count = np.random.choice(dist["values"], p=dist["probs"])
                else:
                    if task_id in global_task_dists:
                        dist = global_task_dists[task_id]
                        count = np.random.choice(dist["values"], p=dist["probs"])
                    else:
                        count = 0
                
                effective_count = min(int(count), max_count)
                earned_points = effective_count * task_point
                customer_monthly_points += earned_points
            
            month_data.append({
                'musteri_id': customer_id,
                'ay': month_num,
                'aylik_puan': customer_monthly_points,
                'is_new_customer': customer_id in new_customer_mapping
            })
            
            customer_count += 1
            if customer_count % 100000 == 0:
                print(f"    Ay {month_num}: {customer_count:,} / {len(active_customers):,} müşteri işlendi")
        
        monthly_results.extend(month_data)
        
        month_duration = time.time() - month_start
        print(f"  Ay {month_num} tamamlandı - {len(active_customers):,} müşteri - {month_duration:.1f} saniye")
    
    # ADIM 4: Sonuçları hesapla ve kaydet
    print("\n[4/4] Sonuçlar hesaplanıyor...")
    
    monthly_df = pd.DataFrame(monthly_results)
    
    # Yıllık toplamlar
    yearly_customer_results = monthly_df.groupby('musteri_id').agg({
        'aylik_puan': 'sum',
        'is_new_customer': 'first'
    }).reset_index()
    yearly_customer_results.columns = ['musteri_id', 'yillik_toplam_puan', 'is_new_customer']
    yearly_customer_results['yil'] = simulation_year
    
    # Threshold belirleme
    def determine_threshold(points):
        if points >= thresholds["T3"]["value"]:
            return "T3"
        elif points >= thresholds["T2"]["value"]:
            return "T2"
        elif points >= thresholds["T1"]["value"]:
            return "T1"
        else:
            return "T0"
    
    yearly_customer_results['gecilen_threshold'] = yearly_customer_results['yillik_toplam_puan'].apply(determine_threshold)
    
    # Aylık özet
    monthly_df_sorted = monthly_df.sort_values(['musteri_id', 'ay'])
    monthly_df_sorted['kumulatif_puan'] = monthly_df_sorted.groupby('musteri_id')['aylik_puan'].cumsum()
    
    summary_data = []
    for month in range(1, 13):
        month_end_data = monthly_df_sorted[monthly_df_sorted['ay'] == month]
        
        if len(month_end_data) == 0:
            continue
        
        total_customers = len(month_end_data)
        
        t1_count = (month_end_data['kumulatif_puan'] >= thresholds["T1"]["value"]).sum()
        t2_count = (month_end_data['kumulatif_puan'] >= thresholds["T2"]["value"]).sum()
        t3_count = (month_end_data['kumulatif_puan'] >= thresholds["T3"]["value"]).sum()
        
        t1_reward = t1_count * thresholds["T1"]["reward"]
        t2_reward = t2_count * thresholds["T2"]["reward"]
        t3_reward = t3_count * thresholds["T3"]["reward"]
        
        summary_data.append({
            'yil': simulation_year,
            'ay': month,
            'toplam_musteri_sayisi': total_customers,
            'T1_ustunde_musteri_sayisi': int(t1_count),
            'T2_ustunde_musteri_sayisi': int(t2_count),
            'T3_ustunde_musteri_sayisi': int(t3_count),
            'T1_odul_tutari': int(t1_reward),
            'T2_odul_tutari': int(t2_reward),
            'T3_odul_tutari': int(t3_reward),
            'toplam_odul_tutari': int(t1_reward + t2_reward + t3_reward),
            'T1_oran': t1_count / total_customers if total_customers > 0 else 0,
            'T2_oran': t2_count / total_customers if total_customers > 0 else 0,
            'T3_oran': t3_count / total_customers if total_customers > 0 else 0,
        })
    
    monthly_summary = pd.DataFrame(summary_data)
    
    # Kaydet
    yearly_customer_results.to_csv('yearly_results.csv', index=False)
    monthly_summary.to_csv('monthly_summary.csv', index=False)
    
    total_duration = time.time() - start_time
    print(f"\n{'='*50}")
    print(f"SİMÜLASYON TAMAMLANDI!")
    print(f"Toplam süre: {total_duration/60:.1f} dakika")
    print(f"{'='*50}")
    print(f"\nKaydedilen dosyalar:")
    print(f"  - yearly_results.csv ({len(yearly_customer_results):,} satır)")
    print(f"  - monthly_summary.csv ({len(monthly_summary)} satır)")
    print(f"  - distributions.pkl")
    
    return yearly_customer_results, monthly_summary


# =============================================================================
# ANA ÇALIŞTIRMA
# =============================================================================

if __name__ == "__main__":
    
    print("="*60)
    print("ADIM 1: SİMÜLASYON")
    print("="*60)
    
    # VERİYİ YÜKLE
    # df = pd.read_csv('your_data.csv')  # veya kendi df'in
    # VEYA
    # df zaten hafızadaysa direkt kullan
    
    print("\n⚠️  ÖNEMLİ: df değişkenini tanımlamalısın!")
    print("Örnek:")
    print("  df = pd.read_csv('musteri_data.csv')")
    print("  veya")
    print("  df zaten notebook'ta varsa bu scripti import et")
    
    # Simülasyonu çalıştır
    # yearly_results, monthly_summary = simulate_year(
    #     df=df,
    #     tasks_config=tasks_config,
    #     thresholds=thresholds,
    #     start_customers=START_CUSTOMERS,
    #     end_customers=END_CUSTOMERS,
    #     simulation_year=SIMULATION_YEAR,
    #     decay=DECAY,
    #     random_seed=RANDOM_SEED
    # )








### 2
"""
ADIM 2: ÖZET RAPOR
==================
Simülasyon sonuçlarını okur ve özet rapor yazdırır.
01_simulation.py çalıştıktan sonra kullan.
"""

import pandas as pd

# =============================================================================
# AYARLAR
# =============================================================================

# Hedef oranlar
TARGET_RATES = {
    "T1": 0.70,
    "T2": 0.40,
    "T3": 0.05,
}

# Threshold değerleri (ödül tutarı hesabı için)
thresholds = {
    "T1": {"value": 1000, "reward": 10},
    "T2": {"value": 2500, "reward": 10},
    "T3": {"value": 4000, "reward": 10},
}


# =============================================================================
# ÖZET FONKSİYONLARI
# =============================================================================

def load_results():
    """CSV dosyalarından sonuçları yükler."""
    print("Sonuçlar yükleniyor...")
    yearly_results = pd.read_csv('yearly_results.csv')
    monthly_summary = pd.read_csv('monthly_summary.csv')
    print(f"  - yearly_results: {len(yearly_results):,} satır")
    print(f"  - monthly_summary: {len(monthly_summary)} satır")
    return yearly_results, monthly_summary


def calculate_summary(yearly_results, monthly_summary):
    """Özet istatistikleri hesaplar."""
    
    total_customers = len(yearly_results)
    
    # Threshold bazlı sayılar
    threshold_counts = yearly_results['gecilen_threshold'].value_counts()
    
    # T1 ve üstü (T1, T2, T3)
    t1_plus = 0
    for t in ['T1', 'T2', 'T3']:
        t1_plus = t1_plus + threshold_counts.get(t, 0)
    
    t2_plus = 0
    for t in ['T2', 'T3']:
        t2_plus = t2_plus + threshold_counts.get(t, 0)
    
    t3_plus = threshold_counts.get('T3', 0)
    
    # Oranlar
    t1_rate = t1_plus / total_customers if total_customers > 0 else 0
    t2_rate = t2_plus / total_customers if total_customers > 0 else 0
    t3_rate = t3_plus / total_customers if total_customers > 0 else 0
    
    # Ödül tutarları
    t1_reward_total = t1_plus * thresholds["T1"]["reward"]
    t2_reward_total = t2_plus * thresholds["T2"]["reward"]
    t3_reward_total = t3_plus * thresholds["T3"]["reward"]
    total_reward = t1_reward_total + t2_reward_total + t3_reward_total
    
    # Puan istatistikleri
    points_stats = yearly_results['yillik_toplam_puan'].describe()
    
    summary = {
        'toplam_musteri': total_customers,
        'threshold_counts': {
            'T0': threshold_counts.get('T0', 0),
            'T1': threshold_counts.get('T1', 0),
            'T2': threshold_counts.get('T2', 0),
            'T3': threshold_counts.get('T3', 0),
        },
        'kumulatif_counts': {
            'T1_ve_ustu': t1_plus,
            'T2_ve_ustu': t2_plus,
            'T3_ve_ustu': t3_plus,
        },
        'gerceklesen_oranlar': {
            'T1': t1_rate,
            'T2': t2_rate,
            'T3': t3_rate,
        },
        'hedef_oranlar': TARGET_RATES,
        'oran_farklari': {
            'T1': t1_rate - TARGET_RATES['T1'],
            'T2': t2_rate - TARGET_RATES['T2'],
            'T3': t3_rate - TARGET_RATES['T3'],
        },
        'odul_tutarlari': {
            'T1': t1_reward_total,
            'T2': t2_reward_total,
            'T3': t3_reward_total,
            'toplam': total_reward,
        },
        'puan_istatistikleri': {
            'ortalama': points_stats['mean'],
            'medyan': points_stats['50%'],
            'std': points_stats['std'],
            'min': points_stats['min'],
            'max': points_stats['max'],
        }
    }
    
    return summary


def print_summary_report(summary):
    """Özet raporu ekrana yazdırır."""
    
    print("\n" + "="*70)
    print("YILLIK SİMÜLASYON SONUÇ RAPORU")
    print("="*70)
    
    print(f"\nToplam Müşteri Sayısı: {summary['toplam_musteri']:,}")
    
    print("\n--- THRESHOLD DAĞILIMI ---")
    for t, count in summary['threshold_counts'].items():
        pct = count / summary['toplam_musteri'] * 100
        print(f"  {t}: {count:,} müşteri ({pct:.1f}%)")
    
    print("\n--- KÜMÜLATİF ORANLAR (Hedef vs Gerçekleşen) ---")
    for t in ['T1', 'T2', 'T3']:
        gercek = summary['gerceklesen_oranlar'][t] * 100
        hedef = summary['hedef_oranlar'][t] * 100
        fark = summary['oran_farklari'][t] * 100
        if abs(fark) < 5:
            emoji = "✓"
        elif fark > 0:
            emoji = "↑"
        else:
            emoji = "↓"
        print(f"  {t}: Hedef %{hedef:.0f} | Gerçekleşen %{gercek:.1f} | Fark: {fark:+.1f}% {emoji}")
    
    print("\n--- ÖDÜL TUTARLARI ---")
    for t in ['T1', 'T2', 'T3']:
        print(f"  {t}: {summary['odul_tutarlari'][t]:,.0f} TL")
    print(f"  TOPLAM: {summary['odul_tutarlari']['toplam']:,.0f} TL")
    
    print("\n--- PUAN İSTATİSTİKLERİ ---")
    stats = summary['puan_istatistikleri']
    print(f"  Ortalama: {stats['ortalama']:,.0f} puan")
    print(f"  Medyan: {stats['medyan']:,.0f} puan")
    print(f"  Std Sapma: {stats['std']:,.0f} puan")
    print(f"  Min-Max: {stats['min']:,.0f} - {stats['max']:,.0f} puan")
    
    print("\n" + "="*70)


def print_monthly_summary(monthly_summary):
    """Aylık özeti tablo olarak yazdırır."""
    
    print("\n" + "="*70)
    print("AYLIK ÖZET")
    print("="*70)
    
    print("\n{:<5} {:>12} {:>10} {:>10} {:>10} {:>15}".format(
        "Ay", "Müşteri", "T1+", "T2+", "T3+", "Toplam Ödül"
    ))
    print("-"*70)
    
    for idx, row in monthly_summary.iterrows():
        print("{:<5} {:>12,} {:>10,} {:>10,} {:>10,} {:>15,} TL".format(
            int(row['ay']),
            int(row['toplam_musteri_sayisi']),
            int(row['T1_ustunde_musteri_sayisi']),
            int(row['T2_ustunde_musteri_sayisi']),
            int(row['T3_ustunde_musteri_sayisi']),
            int(row['toplam_odul_tutari'])
        ))
    
    print("-"*70)
    print("Yıl Sonu Toplam Ödül: {:,} TL".format(int(monthly_summary['toplam_odul_tutari'].iloc[-1])))


# =============================================================================
# ANA ÇALIŞTIRMA
# =============================================================================

if __name__ == "__main__":
    
    print("="*60)
    print("ADIM 2: ÖZET RAPOR")
    print("="*60)
    
    # Sonuçları yükle
    yearly_results, monthly_summary = load_results()
    
    # Özeti hesapla
    summary = calculate_summary(yearly_results, monthly_summary)
    
    # Raporları yazdır
    print_summary_report(summary)
    print_monthly_summary(monthly_summary)





####3
"""
ADIM 3: GRAFİKLER
=================
Simülasyon sonuçlarını görselleştirir.
01_simulation.py çalıştıktan sonra kullan.
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import pickle

# =============================================================================
# AYARLAR
# =============================================================================

# Hedef oranlar
TARGET_RATES = {
    "T1": 0.70,
    "T2": 0.40,
    "T3": 0.05,
}

# Threshold değerleri
thresholds = {
    "T1": {"value": 1000, "reward": 10},
    "T2": {"value": 2500, "reward": 10},
    "T3": {"value": 4000, "reward": 10},
}

# Türkçe karakter desteği
plt.rcParams['font.family'] = 'DejaVu Sans'


# =============================================================================
# VERİ YÜKLEME
# =============================================================================

def load_all_data():
    """Tüm sonuç dosyalarını yükler."""
    
    print("Veriler yükleniyor...")
    
    # CSV'leri yükle
    yearly_results = pd.read_csv('yearly_results.csv')
    monthly_summary = pd.read_csv('monthly_summary.csv')
    
    # Dağılımları yükle
    with open('distributions.pkl', 'rb') as f:
        distributions = pickle.load(f)
    
    global_task_dists = distributions['global_task_dists']
    
    print(f"  - yearly_results: {len(yearly_results):,} satır")
    print(f"  - monthly_summary: {len(monthly_summary)} satır")
    print(f"  - global_task_dists: {len(global_task_dists)} görev")
    
    return yearly_results, monthly_summary, global_task_dists


# =============================================================================
# GRAFİK FONKSİYONLARI
# =============================================================================

def plot_results(yearly_results, monthly_summary, global_task_dists, save_path='plots.png'):
    """6 panelli grafik oluşturur."""
    
    print("\nGrafikler oluşturuluyor...")
    
    fig, axes = plt.subplots(2, 3, figsize=(18, 12))
    
    # 1. Görev bazlı dağılım (ilk 3 görev)
    ax1 = axes[0, 0]
    task_ids = list(global_task_dists.keys())[:3]
    
    for i, task_id in enumerate(task_ids):
        dist = global_task_dists[task_id]
        ax1.bar(
            dist["values"] + i*0.2, 
            dist["probs"], 
            width=0.2, 
            alpha=0.7, 
            label=f"Görev {task_id}"
        )
    
    ax1.set_xlabel('Görev Sayısı')
    ax1.set_ylabel('Olasılık')
    ax1.set_title('Görev Bazlı Recency-Weighted Dağılımlar')
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # 2. Aylık threshold geçen müşteri sayıları
    ax2 = axes[0, 1]
    months = monthly_summary['ay']
    ax2.plot(months, monthly_summary['T1_ustunde_musteri_sayisi'], 'g-o', label='T1+', linewidth=2)
    ax2.plot(months, monthly_summary['T2_ustunde_musteri_sayisi'], 'b-s', label='T2+', linewidth=2)
    ax2.plot(months, monthly_summary['T3_ustunde_musteri_sayisi'], 'r-^', label='T3+', linewidth=2)
    ax2.set_xlabel('Ay')
    ax2.set_ylabel('Müşteri Sayısı')
    ax2.set_title('Aylık Kümülatif Threshold Geçen Müşteriler')
    ax2.legend()
    ax2.grid(True, alpha=0.3)
    ax2.set_xticks(range(1, 13))
    
    # 3. Aylık müşteri artışı
    ax3 = axes[0, 2]
    ax3.bar(months, monthly_summary['toplam_musteri_sayisi'], color='steelblue', alpha=0.7)
    ax3.set_xlabel('Ay')
    ax3.set_ylabel('Toplam Müşteri')
    ax3.set_title('Aylık Toplam Müşteri Sayısı')
    ax3.grid(True, alpha=0.3, axis='y')
    ax3.set_xticks(range(1, 13))
    
    # Sayıları bar'ların üzerine yaz
    for i, v in enumerate(monthly_summary['toplam_musteri_sayisi']):
        ax3.text(i+1, v + v*0.01, f'{v/1e6:.2f}M', ha='center', va='bottom', fontsize=8)
    
    # 4. Yıllık puan dağılımı histogram
    ax4 = axes[1, 0]
    points = yearly_results['yillik_toplam_puan']
    ax4.hist(points, bins=50, color='purple', alpha=0.7, edgecolor='black')
    
    # Threshold çizgileri
    for t_name, t_info in thresholds.items():
        ax4.axvline(x=t_info['value'], color='red', linestyle='--', linewidth=2, label=f"{t_name}: {t_info['value']}")
    
    ax4.set_xlabel('Yıllık Toplam Puan')
    ax4.set_ylabel('Müşteri Sayısı')
    ax4.set_title('Yıllık Puan Dağılımı')
    ax4.legend()
    ax4.grid(True, alpha=0.3)
    
    # 5. Aylık ödül tutarları
    ax5 = axes[1, 1]
    width = 0.25
    x = np.arange(12)
    ax5.bar(x - width, monthly_summary['T1_odul_tutari'], width, label='T1 Ödül', color='green', alpha=0.7)
    ax5.bar(x, monthly_summary['T2_odul_tutari'], width, label='T2 Ödül', color='blue', alpha=0.7)
    ax5.bar(x + width, monthly_summary['T3_odul_tutari'], width, label='T3 Ödül', color='red', alpha=0.7)
    ax5.set_xlabel('Ay')
    ax5.set_ylabel('Ödül Tutarı (TL)')
    ax5.set_title('Aylık Ödül Tutarları')
    ax5.legend()
    ax5.set_xticks(x)
    ax5.set_xticklabels(range(1, 13))
    ax5.grid(True, alpha=0.3, axis='y')
    
    # 6. Threshold oranları zaman serisi
    ax6 = axes[1, 2]
    ax6.plot(months, monthly_summary['T1_oran']*100, 'g-o', label='T1+ %', linewidth=2)
    ax6.plot(months, monthly_summary['T2_oran']*100, 'b-s', label='T2+ %', linewidth=2)
    ax6.plot(months, monthly_summary['T3_oran']*100, 'r-^', label='T3+ %', linewidth=2)
    
    # Hedef çizgileri
    ax6.axhline(y=TARGET_RATES['T1']*100, color='green', linestyle=':', alpha=0.5, label=f"T1 Hedef ({TARGET_RATES['T1']*100:.0f}%)")
    ax6.axhline(y=TARGET_RATES['T2']*100, color='blue', linestyle=':', alpha=0.5, label=f"T2 Hedef ({TARGET_RATES['T2']*100:.0f}%)")
    ax6.axhline(y=TARGET_RATES['T3']*100, color='red', linestyle=':', alpha=0.5, label=f"T3 Hedef ({TARGET_RATES['T3']*100:.0f}%)")
    
    ax6.set_xlabel('Ay')
    ax6.set_ylabel('Oran (%)')
    ax6.set_title('Aylık Threshold Oranları vs Hedef')
    ax6.legend(loc='center left', bbox_to_anchor=(1, 0.5), fontsize=8)
    ax6.grid(True, alpha=0.3)
    ax6.set_xticks(range(1, 13))
    ax6.set_ylim(0, 100)
    
    plt.tight_layout()
    plt.savefig(save_path, dpi=300, bbox_inches='tight')
    
    print(f"\nGrafik kaydedildi: {save_path}")
    
    plt.show()
    
    return fig


# =============================================================================
# ANA ÇALIŞTIRMA
# =============================================================================

if __name__ == "__main__":
    
    print("="*60)
    print("ADIM 3: GRAFİKLER")
    print("="*60)
    
    # Verileri yükle
    yearly_results, monthly_summary, global_task_dists = load_all_data()
    
    # Grafikleri oluştur
    fig = plot_results(yearly_results, monthly_summary, global_task_dists, save_path='plots.png')




###4
"""
ADIM 4: GRID SEARCH OPTİMİZASYONU
=================================
Farklı görev ayarlarını deneyerek hedef oranlara en yakın kombinasyonu bulur.
Bu adım opsiyoneldir.
"""

import numpy as np
import pandas as pd
from datetime import datetime
from dateutil.relativedelta import relativedelta
from collections import defaultdict
import pickle
import time

# =============================================================================
# AYARLAR - BUNLARI DEĞİŞTİR
# =============================================================================

# Hedef oranlar
TARGET_RATES = {
    "T1": 0.70,
    "T2": 0.40,
    "T3": 0.05,
}

# Threshold değerleri
thresholds = {
    "T1": {"value": 1000, "reward": 10},
    "T2": {"value": 2500, "reward": 10},
    "T3": {"value": 4000, "reward": 10},
}

# Mevcut görev konfigürasyonları
tasks_config = {
    1001: {"task_point": 5, "max_count": 10, "start_date": "2023-01-01"},
    1002: {"task_point": 3, "max_count": 8, "start_date": "2024-01-01"},
    # ... diğer görevleri ekle
}

# Optimizasyon parametreleri
TASKS_TO_OPTIMIZE = [1001]          # Hangi görevleri optimize edeceğiz
TASK_POINT_RANGE = (3, 10, 1)       # (min, max, step)
MAX_COUNT_RANGE = (5, 15, 2)        # (min, max, step)
SAMPLE_SIZE = 10000                  # Hız için küçük örneklem
START_CUSTOMERS = 10000
END_CUSTOMERS = 15000
SIMULATION_YEAR = 2026
DECAY = 0.9


# =============================================================================
# YARDIMCI FONKSİYONLAR (01_simulation.py'den kopyalandı)
# =============================================================================

def calculate_months_ago(date, max_date):
    return (max_date.year - date.year) * 12 + (max_date.month - date.month)

def calculate_time_weight(months_ago, decay=0.9):
    return decay ** months_ago

def normalize_weights(weights):
    total = weights.sum()
    if total == 0:
        return np.ones_like(weights) / len(weights)
    return weights / total

def build_recency_weighted_empirical_per_customer_task(df, decay=0.9):
    df = df.copy()
    df['data_date'] = pd.to_datetime(df['data_date'])
    max_date = df['data_date'].max()
    df['months_ago'] = df['data_date'].apply(lambda x: calculate_months_ago(x, max_date))
    df['time_weight'] = df['months_ago'].apply(lambda x: calculate_time_weight(x, decay))
    
    recency_dists = {}
    grouped = df.groupby(['musteri_id', 'gorev_id'])
    
    for (musteri_id, gorev_id), group in grouped:
        value_weights = group.groupby('gorev_orjinal_count')['time_weight'].sum()
        values = value_weights.index.values.astype(float)
        weights = value_weights.values
        probs = normalize_weights(weights)
        recency_dists[(musteri_id, gorev_id)] = {"values": values, "probs": probs}
    
    return recency_dists

def build_global_recency_weighted_empirical_per_task(df, decay=0.9):
    df = df.copy()
    df['data_date'] = pd.to_datetime(df['data_date'])
    max_date = df['data_date'].max()
    df['months_ago'] = df['data_date'].apply(lambda x: calculate_months_ago(x, max_date))
    df['time_weight'] = df['months_ago'].apply(lambda x: calculate_time_weight(x, decay))
    
    global_dists = {}
    grouped = df.groupby('gorev_id')
    
    for gorev_id, group in grouped:
        value_weights = group.groupby('gorev_orjinal_count')['time_weight'].sum()
        values = value_weights.index.values.astype(float)
        weights = value_weights.values
        probs = normalize_weights(weights)
        global_dists[gorev_id] = {"values": values, "probs": probs}
    
    return global_dists

def generate_monthly_customer_counts(start_customers, end_customers, months=12):
    result = []
    for i in range(months):
        customer_count = int(start_customers + (end_customers - start_customers) * i / (months - 1))
        result.append(customer_count)
    return result


# =============================================================================
# HIZLI SİMÜLASYON (Sessiz, sadece sonuç döndürür)
# =============================================================================

def quick_simulate(df, tasks_config, thresholds, customer_task_dists, global_task_dists,
                   start_customers, end_customers, simulation_year, random_seed=42):
    """Hızlı simülasyon - print yok, sadece oranları döndürür."""
    
    np.random.seed(random_seed)
    
    existing_customers = set(df['musteri_id'].unique())
    monthly_counts = generate_monthly_customer_counts(start_customers, end_customers)
    all_task_ids = list(tasks_config.keys())
    
    max_existing_id = max(existing_customers) if existing_customers else 0
    new_customer_id_counter = max_existing_id + 1
    
    active_customers = set()
    new_customer_mapping = {}
    monthly_results = []
    
    for month_idx in range(12):
        month_num = month_idx + 1
        month_end_date = datetime(simulation_year, month_num, 1) + relativedelta(months=1, days=-1)
        target_customer_count = monthly_counts[month_idx]
        
        current_count = len(active_customers)
        new_customers_needed = target_customer_count - current_count
        
        if month_idx == 0:
            if len(existing_customers) >= target_customer_count:
                active_customers = set(np.random.choice(
                    list(existing_customers), 
                    size=target_customer_count, 
                    replace=False
                ))
            else:
                active_customers = existing_customers.copy()
                new_needed = target_customer_count - len(active_customers)
                for _ in range(new_needed):
                    new_customer_mapping[new_customer_id_counter] = month_num
                    active_customers.add(new_customer_id_counter)
                    new_customer_id_counter += 1
        else:
            for _ in range(max(0, new_customers_needed)):
                new_customer_mapping[new_customer_id_counter] = month_num
                active_customers.add(new_customer_id_counter)
                new_customer_id_counter += 1
        
        for customer_id in active_customers:
            customer_monthly_points = 0
            
            for task_id in all_task_ids:
                task_cfg = tasks_config[task_id]
                task_start = pd.to_datetime(task_cfg["start_date"])
                
                if month_end_date < task_start:
                    continue
                
                task_point = task_cfg["task_point"]
                max_count = task_cfg["max_count"]
                
                if customer_id in existing_customers and (customer_id, task_id) in customer_task_dists:
                    dist = customer_task_dists[(customer_id, task_id)]
                    count = np.random.choice(dist["values"], p=dist["probs"])
                else:
                    if task_id in global_task_dists:
                        dist = global_task_dists[task_id]
                        count = np.random.choice(dist["values"], p=dist["probs"])
                    else:
                        count = 0
                
                effective_count = min(int(count), max_count)
                earned_points = effective_count * task_point
                customer_monthly_points += earned_points
            
            monthly_results.append({
                'musteri_id': customer_id,
                'ay': month_num,
                'aylik_puan': customer_monthly_points
            })
    
    # Yıllık toplamlar
    monthly_df = pd.DataFrame(monthly_results)
    yearly_results = monthly_df.groupby('musteri_id')['aylik_puan'].sum().reset_index()
    yearly_results.columns = ['musteri_id', 'yillik_toplam_puan']
    
    # Threshold belirleme
    def determine_threshold(points):
        if points >= thresholds["T3"]["value"]:
            return "T3"
        elif points >= thresholds["T2"]["value"]:
            return "T2"
        elif points >= thresholds["T1"]["value"]:
            return "T1"
        else:
            return "T0"
    
    yearly_results['gecilen_threshold'] = yearly_results['yillik_toplam_puan'].apply(determine_threshold)
    
    # Oranları hesapla
    total = len(yearly_results)
    t1_rate = (yearly_results['gecilen_threshold'].isin(['T1', 'T2', 'T3'])).sum() / total
    t2_rate = (yearly_results['gecilen_threshold'].isin(['T2', 'T3'])).sum() / total
    t3_rate = (yearly_results['gecilen_threshold'] == 'T3').sum() / total
    
    return t1_rate, t2_rate, t3_rate


# =============================================================================
# GRID SEARCH
# =============================================================================

def grid_search_optimization(df, tasks_config, thresholds, target_rates,
                             tasks_to_optimize, task_point_range, max_count_range,
                             sample_size, start_customers, end_customers, 
                             simulation_year, decay=0.9):
    """Grid search optimizasyonu."""
    
    print("\n" + "="*70)
    print("GRID SEARCH OPTİMİZASYONU")
    print("="*70)
    
    start_time = time.time()
    
    # Örneklem al
    print("\n[1/3] Örneklem alınıyor...")
    unique_customers = df['musteri_id'].unique()
    if len(unique_customers) > sample_size:
        sample_customers = np.random.choice(unique_customers, size=sample_size, replace=False)
        df_sample = df[df['musteri_id'].isin(sample_customers)].copy()
    else:
        df_sample = df.copy()
    
    print(f"  Örneklem: {df_sample['musteri_id'].nunique():,} müşteri, {len(df_sample):,} satır")
    
    # Dağılımları oluştur
    print("\n[2/3] Dağılımlar oluşturuluyor...")
    customer_task_dists = build_recency_weighted_empirical_per_customer_task(df_sample, decay)
    global_task_dists = build_global_recency_weighted_empirical_per_task(df_sample, decay)
    
    # Grid arama
    print("\n[3/3] Kombinasyonlar deneniyor...")
    
    task_points = list(range(task_point_range[0], task_point_range[1] + 1, task_point_range[2]))
    max_counts = list(range(max_count_range[0], max_count_range[1] + 1, max_count_range[2]))
    
    results = []
    total_combinations = len(task_points) * len(max_counts)
    combination_count = 0
    
    if len(tasks_to_optimize) == 1:
        task_id = tasks_to_optimize[0]
        
        for tp in task_points:
            for mc in max_counts:
                combination_count += 1
                
                # Config kopyala ve güncelle
                test_config = {}
                for k, v in tasks_config.items():
                    test_config[k] = v.copy()
                test_config[task_id]["task_point"] = tp
                test_config[task_id]["max_count"] = mc
                
                # Simülasyon
                t1_rate, t2_rate, t3_rate = quick_simulate(
                    df_sample, test_config, thresholds,
                    customer_task_dists, global_task_dists,
                    start_customers, end_customers, simulation_year
                )
                
                # Hata hesapla (MSE)
                error = (
                    (t1_rate - target_rates['T1'])**2 +
                    (t2_rate - target_rates['T2'])**2 +
                    (t3_rate - target_rates['T3'])**2
                )
                
                results.append({
                    'gorev_id': task_id,
                    'task_point': tp,
                    'max_count': mc,
                    'T1_oran': round(t1_rate * 100, 1),
                    'T2_oran': round(t2_rate * 100, 1),
                    'T3_oran': round(t3_rate * 100, 1),
                    'error': round(error, 6)
                })
                
                if combination_count % 5 == 0:
                    print(f"  {combination_count}/{total_combinations} tamamlandı...")
    
    # Sonuçları sırala
    results_df = pd.DataFrame(results)
    results_df = results_df.sort_values('error')
    
    # Kaydet
    results_df.to_csv('optimization_results.csv', index=False)
    
    duration = time.time() - start_time
    
    print(f"\n{'='*70}")
    print("OPTİMİZASYON TAMAMLANDI!")
    print(f"Süre: {duration:.1f} saniye")
    print(f"{'='*70}")
    
    print(f"\nHedefler: T1={target_rates['T1']*100:.0f}%, T2={target_rates['T2']*100:.0f}%, T3={target_rates['T3']*100:.0f}%")
    
    print("\n--- EN İYİ 5 KOMBİNASYON ---")
    print(results_df.head(10).to_string(index=False))
    
    print("\n--- EN KÖTÜ 5 KOMBİNASYON ---")
    print(results_df.tail(5).to_string(index=False))
    
    print(f"\nSonuçlar kaydedildi: optimization_results.csv")
    
    return results_df


# =============================================================================
# ANA ÇALIŞTIRMA
# =============================================================================

if __name__ == "__main__":
    
    print("="*60)
    print("ADIM 4: GRID SEARCH OPTİMİZASYONU")
    print("="*60)
    
    print("\n⚠️  ÖNEMLİ: df değişkenini tanımlamalısın!")
    print("Örnek:")
    print("  df = pd.read_csv('musteri_data.csv')")
    
    # Grid search çalıştır
    # results = grid_search_optimization(
    #     df=df,
    #     tasks_config=tasks_config,
    #     thresholds=thresholds,
    #     target_rates=TARGET_RATES,
    #     tasks_to_optimize=TASKS_TO_OPTIMIZE,
    #     task_point_range=TASK_POINT_RANGE,
    #     max_count_range=MAX_COUNT_RANGE,
    #     sample_size=SAMPLE_SIZE,
    #     start_customers=START_CUSTOMERS,
    #     end_customers=END_CUSTOMERS,
    #     simulation_year=SIMULATION_YEAR,
    #     decay=DECAY
    # )




###5

import numpy as np
import pandas as pd
from datetime import datetime
from dateutil.relativedelta import relativedelta
from collections import defaultdict
import pickle
import time
import matplotlib.pyplot as plt


# Görev konfigürasyonları
tasks_config = {
    1001: {"task_point": 5, "max_count": 10, "start_date": "2023-01-01"},
    1002: {"task_point": 3, "max_count": 8, "start_date": "2024-01-01"},
    # ... diğer görevleri ekle
}

# Threshold değerleri
thresholds = {
    "T1": {"value": 1000, "reward": 10},
    "T2": {"value": 2500, "reward": 10},
    "T3": {"value": 4000, "reward": 10},
}

# Hedef oranlar
TARGET_RATES = {
    "T1": 0.70,
    "T2": 0.40,
    "T3": 0.05,
}

# Simülasyon parametreleri
START_CUSTOMERS = 1_000_000
END_CUSTOMERS = 1_500_000
SIMULATION_YEAR = 2026
DECAY = 0.9
RANDOM_SEED = 42



yearly_results, monthly_summary = simulate_year(
    df=df,
    tasks_config=tasks_config,
    thresholds=thresholds,
    start_customers=START_CUSTOMERS,
    end_customers=END_CUSTOMERS,
    simulation_year=SIMULATION_YEAR,
    decay=DECAY,
    random_seed=RANDOM_SEED
)

## simülasyon sonucu
print("Yıllık sonuçlar:")
print(yearly_results.head(10))
print(f"\nToplam: {len(yearly_results):,} müşteri")


## özet rapor sonucu
summary = calculate_summary(yearly_results, monthly_summary)
print_summary_report(summary)
print_monthly_summary(monthly_summary)

##grafikler
# Dağılımları yükle (simülasyonda kaydedilmişti)
with open('distributions.pkl', 'rb') as f:
    distributions = pickle.load(f)
global_task_dists = distributions['global_task_dists']

# Grafikleri çiz
fig = plot_results(yearly_results, monthly_summary, global_task_dists, save_path='plots.png')


##
