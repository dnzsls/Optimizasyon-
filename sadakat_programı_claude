def build_recency_weighted_empirical_per_customer_task(df, decay=0.9):
    """Her (musteri_id, gorev_id) çifti için recency-weighted dağılım oluşturur."""
    
    print("Müşteri-görev dağılımları oluşturuluyor...")
    start_time = time.time()
    
    df = df.copy()
    df['data_date'] = pd.to_datetime(df['data_date'])
    max_date = df['data_date'].max()
    
    # Vektörel hesaplama (apply yerine)
    df['months_ago'] = (max_date.year - df['data_date'].dt.year) * 12 + (max_date.month - df['data_date'].dt.month)
    df['time_weight'] = decay ** df['months_ago']
    
    print(f"  Ağırlıklar hesaplandı: {time.time() - start_time:.1f} saniye")
    
    # Grupla ve topla
    grouped = df.groupby(['musteri_id', 'gorev_id', 'gorev_orjinal_count'])['time_weight'].sum().reset_index()
    
    print(f"  Gruplama tamamlandı: {time.time() - start_time:.1f} saniye")
    
    # Dictionary oluştur
    recency_dists = {}
    
    grouped_by_cust_task = grouped.groupby(['musteri_id', 'gorev_id'])
    total_groups = len(grouped_by_cust_task)
    
    for idx, ((musteri_id, gorev_id), group) in enumerate(grouped_by_cust_task):
        values = group['gorev_orjinal_count'].values.astype(float)
        weights = group['time_weight'].values
        probs = weights / weights.sum()
        
        recency_dists[(musteri_id, gorev_id)] = {
            "values": values,
            "probs": probs
        }
        
        if (idx + 1) % 100000 == 0:
            print(f"  {idx + 1:,} / {total_groups:,} tamamlandı")
    
    print(f"Toplam {len(recency_dists):,} dağılım oluşturuldu. Süre: {time.time() - start_time:.1f} saniye")
    return recency_dists


def build_global_recency_weighted_empirical_per_task(df, decay=0.9):
    """Her gorev_id için global recency-weighted dağılım oluşturur."""
    
    print("Global görev dağılımları oluşturuluyor...")
    start_time = time.time()
    
    df = df.copy()
    df['data_date'] = pd.to_datetime(df['data_date'])
    max_date = df['data_date'].max()
    
    # Vektörel hesaplama
    df['months_ago'] = (max_date.year - df['data_date'].dt.year) * 12 + (max_date.month - df['data_date'].dt.month)
    df['time_weight'] = decay ** df['months_ago']
    
    # Grupla ve topla
    grouped = df.groupby(['gorev_id', 'gorev_orjinal_count'])['time_weight'].sum().reset_index()
    
    global_dists = {}
    
    for gorev_id, group in grouped.groupby('gorev_id'):
        values = group['gorev_orjinal_count'].values.astype(float)
        weights = group['time_weight'].values
        probs = weights / weights.sum()
        
        global_dists[gorev_id] = {
            "values": values,
            "probs": probs
        }
    
    print(f"Toplam {len(global_dists)} görev dağılımı oluşturuldu. Süre: {time.time() - start_time:.1f} saniye")
    return global_dists
